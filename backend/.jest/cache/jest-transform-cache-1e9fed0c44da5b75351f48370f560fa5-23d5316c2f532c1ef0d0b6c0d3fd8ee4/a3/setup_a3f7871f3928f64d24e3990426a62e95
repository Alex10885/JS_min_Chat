c20a38a0eede2f1036ba8777774fd957
const mongoose = require('mongoose');
const {
  MongoMemoryServer
} = require('mongodb-memory-server');
const {
  connectDB,
  closeDB
} = require('../db/connection');
const {
  TestFixtures
} = require('./shared/testFixtures');
let originalMongoUri;
let mongod;
beforeAll(async () => {
  // Enable garbage collection for performance optimization
  if (global.gc) {
    global.gc();
  }

  // Save original MongoDB URI
  originalMongoUri = process.env.MONGODB_URI;

  // Start in-memory MongoDB server for tests with compatible version
  mongod = await MongoMemoryServer.create({
    binary: {
      version: '4.4.1' // Compatible version for debian-x64
    }
  });
  const mongoUri = mongod.getUri();

  // Set test environment variables
  process.env.NODE_ENV = 'test';
  process.env.MONGODB_URI = mongoUri;
  process.env.JWT_SECRET = 'your_super_secure_jwt_secret_key_here_replace_in_production';

  // Connect to in-memory test database
  await connectDB();

  // Setup reusable fixtures for faster test execution
  console.log('Setting up test fixtures...');
  await TestFixtures.setup();
});
afterAll(async () => {
  // console.log('Cleaning up test fixtures...'); // Disabled to avoid mocking issues
  await TestFixtures.cleanup();
  await closeDB();

  // Stop the in-memory MongoDB server
  if (mongod) {
    await mongod.stop();
  }

  // Restore original URI if needed
  process.env.MONGODB_URI = originalMongoUri;

  // Final garbage collection
  if (global.gc) {
    global.gc();
  }
});
afterEach(async () => {
  // Clear all collections after each test
  if (mongoose.connection.readyState === 1) {
    // Connected
    const collections = mongoose.connection.collections;
    for (const key in collections) {
      await collections[key].deleteMany({});
    }
  }
});

// Global test timeouts and stabilization
jest.setTimeout(30000); // 30 second global timeout
process.env.NODE_TEST_TIMEOUT = 25000; // Custom env for HTTP tests

// Increase socket timeout for database operations
mongoose.set('bufferCommands', false); // Disable mongoose buffering
mongoose.set('maxTimeMS', 20000); // 20 second limit for operations
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJNb25nb01lbW9yeVNlcnZlciIsImNvbm5lY3REQiIsImNsb3NlREIiLCJUZXN0Rml4dHVyZXMiLCJvcmlnaW5hbE1vbmdvVXJpIiwibW9uZ29kIiwiYmVmb3JlQWxsIiwiZ2xvYmFsIiwiZ2MiLCJwcm9jZXNzIiwiZW52IiwiTU9OR09EQl9VUkkiLCJjcmVhdGUiLCJiaW5hcnkiLCJ2ZXJzaW9uIiwibW9uZ29VcmkiLCJnZXRVcmkiLCJOT0RFX0VOViIsIkpXVF9TRUNSRVQiLCJjb25zb2xlIiwibG9nIiwic2V0dXAiLCJhZnRlckFsbCIsImNsZWFudXAiLCJzdG9wIiwiYWZ0ZXJFYWNoIiwiY29ubmVjdGlvbiIsInJlYWR5U3RhdGUiLCJjb2xsZWN0aW9ucyIsImtleSIsImRlbGV0ZU1hbnkiLCJqZXN0Iiwic2V0VGltZW91dCIsIk5PREVfVEVTVF9USU1FT1VUIiwic2V0Il0sInNvdXJjZXMiOlsic2V0dXAuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgbW9uZ29vc2UgPSByZXF1aXJlKCdtb25nb29zZScpO1xuY29uc3QgeyBNb25nb01lbW9yeVNlcnZlciB9ID0gcmVxdWlyZSgnbW9uZ29kYi1tZW1vcnktc2VydmVyJyk7XG5jb25zdCB7IGNvbm5lY3REQiwgY2xvc2VEQiB9ID0gcmVxdWlyZSgnLi4vZGIvY29ubmVjdGlvbicpO1xuY29uc3QgeyBUZXN0Rml4dHVyZXMgfSA9IHJlcXVpcmUoJy4vc2hhcmVkL3Rlc3RGaXh0dXJlcycpO1xuXG5sZXQgb3JpZ2luYWxNb25nb1VyaTtcbmxldCBtb25nb2Q7XG5cbmJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgLy8gRW5hYmxlIGdhcmJhZ2UgY29sbGVjdGlvbiBmb3IgcGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uXG4gICAgaWYgKGdsb2JhbC5nYykge1xuICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgfVxuXG4gICAgLy8gU2F2ZSBvcmlnaW5hbCBNb25nb0RCIFVSSVxuICAgIG9yaWdpbmFsTW9uZ29VcmkgPSBwcm9jZXNzLmVudi5NT05HT0RCX1VSSTtcblxuICAgIC8vIFN0YXJ0IGluLW1lbW9yeSBNb25nb0RCIHNlcnZlciBmb3IgdGVzdHMgd2l0aCBjb21wYXRpYmxlIHZlcnNpb25cbiAgICBtb25nb2QgPSBhd2FpdCBNb25nb01lbW9yeVNlcnZlci5jcmVhdGUoe1xuICAgICAgYmluYXJ5OiB7XG4gICAgICAgIHZlcnNpb246ICc0LjQuMScgLy8gQ29tcGF0aWJsZSB2ZXJzaW9uIGZvciBkZWJpYW4teDY0XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgbW9uZ29VcmkgPSBtb25nb2QuZ2V0VXJpKCk7XG5cbiAgICAvLyBTZXQgdGVzdCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICd0ZXN0JztcbiAgICBwcm9jZXNzLmVudi5NT05HT0RCX1VSSSA9IG1vbmdvVXJpO1xuICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSAneW91cl9zdXBlcl9zZWN1cmVfand0X3NlY3JldF9rZXlfaGVyZV9yZXBsYWNlX2luX3Byb2R1Y3Rpb24nO1xuXG4gICAgLy8gQ29ubmVjdCB0byBpbi1tZW1vcnkgdGVzdCBkYXRhYmFzZVxuICAgIGF3YWl0IGNvbm5lY3REQigpO1xuXG4gICAgLy8gU2V0dXAgcmV1c2FibGUgZml4dHVyZXMgZm9yIGZhc3RlciB0ZXN0IGV4ZWN1dGlvblxuICAgIGNvbnNvbGUubG9nKCdTZXR0aW5nIHVwIHRlc3QgZml4dHVyZXMuLi4nKTtcbiAgICBhd2FpdCBUZXN0Rml4dHVyZXMuc2V0dXAoKTtcbn0pO1xuXG5hZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgIC8vIGNvbnNvbGUubG9nKCdDbGVhbmluZyB1cCB0ZXN0IGZpeHR1cmVzLi4uJyk7IC8vIERpc2FibGVkIHRvIGF2b2lkIG1vY2tpbmcgaXNzdWVzXG4gICAgIGF3YWl0IFRlc3RGaXh0dXJlcy5jbGVhbnVwKCk7XG4gICAgIGF3YWl0IGNsb3NlREIoKTtcblxuICAgICAvLyBTdG9wIHRoZSBpbi1tZW1vcnkgTW9uZ29EQiBzZXJ2ZXJcbiAgICAgaWYgKG1vbmdvZCkge1xuICAgICAgIGF3YWl0IG1vbmdvZC5zdG9wKCk7XG4gICAgIH1cblxuICAgICAvLyBSZXN0b3JlIG9yaWdpbmFsIFVSSSBpZiBuZWVkZWRcbiAgICAgcHJvY2Vzcy5lbnYuTU9OR09EQl9VUkkgPSBvcmlnaW5hbE1vbmdvVXJpO1xuXG4gICAgIC8vIEZpbmFsIGdhcmJhZ2UgY29sbGVjdGlvblxuICAgICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgIH1cbiB9KTtcblxuYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBDbGVhciBhbGwgY29sbGVjdGlvbnMgYWZ0ZXIgZWFjaCB0ZXN0XG4gICAgaWYgKG1vbmdvb3NlLmNvbm5lY3Rpb24ucmVhZHlTdGF0ZSA9PT0gMSkgeyAvLyBDb25uZWN0ZWRcbiAgICAgIGNvbnN0IGNvbGxlY3Rpb25zID0gbW9uZ29vc2UuY29ubmVjdGlvbi5jb2xsZWN0aW9ucztcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGNvbGxlY3Rpb25zKSB7XG4gICAgICAgIGF3YWl0IGNvbGxlY3Rpb25zW2tleV0uZGVsZXRlTWFueSh7fSk7XG4gICAgICB9XG4gICAgfVxuIH0pO1xuXG4vLyBHbG9iYWwgdGVzdCB0aW1lb3V0cyBhbmQgc3RhYmlsaXphdGlvblxuamVzdC5zZXRUaW1lb3V0KDMwMDAwKTsgIC8vIDMwIHNlY29uZCBnbG9iYWwgdGltZW91dFxucHJvY2Vzcy5lbnYuTk9ERV9URVNUX1RJTUVPVVQgPSAyNTAwMDsgIC8vIEN1c3RvbSBlbnYgZm9yIEhUVFAgdGVzdHNcblxuLy8gSW5jcmVhc2Ugc29ja2V0IHRpbWVvdXQgZm9yIGRhdGFiYXNlIG9wZXJhdGlvbnNcbm1vbmdvb3NlLnNldCgnYnVmZmVyQ29tbWFuZHMnLCBmYWxzZSk7ICAvLyBEaXNhYmxlIG1vbmdvb3NlIGJ1ZmZlcmluZ1xubW9uZ29vc2Uuc2V0KCdtYXhUaW1lTVMnLCAyMDAwMCk7ICAgICAgLy8gMjAgc2Vjb25kIGxpbWl0IGZvciBvcGVyYXRpb25zIl0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxRQUFRLEdBQUdDLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDcEMsTUFBTTtFQUFFQztBQUFrQixDQUFDLEdBQUdELE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztBQUM5RCxNQUFNO0VBQUVFLFNBQVM7RUFBRUM7QUFBUSxDQUFDLEdBQUdILE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQztBQUMxRCxNQUFNO0VBQUVJO0FBQWEsQ0FBQyxHQUFHSixPQUFPLENBQUMsdUJBQXVCLENBQUM7QUFFekQsSUFBSUssZ0JBQWdCO0FBQ3BCLElBQUlDLE1BQU07QUFFVkMsU0FBUyxDQUFDLFlBQVk7RUFDbEI7RUFDQSxJQUFJQyxNQUFNLENBQUNDLEVBQUUsRUFBRTtJQUNiRCxNQUFNLENBQUNDLEVBQUUsQ0FBQyxDQUFDO0VBQ2I7O0VBRUE7RUFDQUosZ0JBQWdCLEdBQUdLLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDQyxXQUFXOztFQUUxQztFQUNBTixNQUFNLEdBQUcsTUFBTUwsaUJBQWlCLENBQUNZLE1BQU0sQ0FBQztJQUN0Q0MsTUFBTSxFQUFFO01BQ05DLE9BQU8sRUFBRSxPQUFPLENBQUM7SUFDbkI7RUFDRixDQUFDLENBQUM7RUFDRixNQUFNQyxRQUFRLEdBQUdWLE1BQU0sQ0FBQ1csTUFBTSxDQUFDLENBQUM7O0VBRWhDO0VBQ0FQLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDTyxRQUFRLEdBQUcsTUFBTTtFQUM3QlIsT0FBTyxDQUFDQyxHQUFHLENBQUNDLFdBQVcsR0FBR0ksUUFBUTtFQUNsQ04sT0FBTyxDQUFDQyxHQUFHLENBQUNRLFVBQVUsR0FBRyw2REFBNkQ7O0VBRXRGO0VBQ0EsTUFBTWpCLFNBQVMsQ0FBQyxDQUFDOztFQUVqQjtFQUNBa0IsT0FBTyxDQUFDQyxHQUFHLENBQUMsNkJBQTZCLENBQUM7RUFDMUMsTUFBTWpCLFlBQVksQ0FBQ2tCLEtBQUssQ0FBQyxDQUFDO0FBQzlCLENBQUMsQ0FBQztBQUVGQyxRQUFRLENBQUMsWUFBWTtFQUNoQjtFQUNBLE1BQU1uQixZQUFZLENBQUNvQixPQUFPLENBQUMsQ0FBQztFQUM1QixNQUFNckIsT0FBTyxDQUFDLENBQUM7O0VBRWY7RUFDQSxJQUFJRyxNQUFNLEVBQUU7SUFDVixNQUFNQSxNQUFNLENBQUNtQixJQUFJLENBQUMsQ0FBQztFQUNyQjs7RUFFQTtFQUNBZixPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsV0FBVyxHQUFHUCxnQkFBZ0I7O0VBRTFDO0VBQ0EsSUFBSUcsTUFBTSxDQUFDQyxFQUFFLEVBQUU7SUFDYkQsTUFBTSxDQUFDQyxFQUFFLENBQUMsQ0FBQztFQUNiO0FBQ0osQ0FBQyxDQUFDO0FBRUhpQixTQUFTLENBQUMsWUFBWTtFQUNsQjtFQUNBLElBQUkzQixRQUFRLENBQUM0QixVQUFVLENBQUNDLFVBQVUsS0FBSyxDQUFDLEVBQUU7SUFBRTtJQUMxQyxNQUFNQyxXQUFXLEdBQUc5QixRQUFRLENBQUM0QixVQUFVLENBQUNFLFdBQVc7SUFDbkQsS0FBSyxNQUFNQyxHQUFHLElBQUlELFdBQVcsRUFBRTtNQUM3QixNQUFNQSxXQUFXLENBQUNDLEdBQUcsQ0FBQyxDQUFDQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdkM7RUFDRjtBQUNILENBQUMsQ0FBQzs7QUFFSDtBQUNBQyxJQUFJLENBQUNDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFFO0FBQ3pCdkIsT0FBTyxDQUFDQyxHQUFHLENBQUN1QixpQkFBaUIsR0FBRyxLQUFLLENBQUMsQ0FBRTs7QUFFeEM7QUFDQW5DLFFBQVEsQ0FBQ29DLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFFO0FBQ3hDcEMsUUFBUSxDQUFDb0MsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFNIiwiaWdub3JlTGlzdCI6W119