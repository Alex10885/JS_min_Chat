d935765c6d1aefb686847dc93f86c388
const io = require('socket.io-client');
const axios = require('axios');
const {
  expect
} = require('expect'); // Jest expect

const BASE_URL = 'http://localhost:3001';
const ioClient = axios.create({
  baseURL: BASE_URL,
  withCredentials: true,
  headers: {
    'User-Agent': 'Session-Test-Agent/1.0'
  }
});
describe('Session Persistence Full Cycle Test', () => {
  let testUser;
  let jwtToken;
  let csrfToken;
  let sessionId;
  let socket;
  beforeAll(() => {
    testUser = {
      nickname: `testuser_${Date.now()}`,
      email: `test_${Date.now()}@example.com`,
      password: 'TestPass123!'
    };
  });
  it('1. Register new user and check session creation', async () => {
    console.log('🧪 TEST 1: Starting user registration...');
    try {
      const registerResponse = await ioClient.post('/api/register', testUser);
      console.log('📥 Registration response:', {
        status: registerResponse.status,
        hasToken: !!registerResponse.data.token,
        hasUser: !!registerResponse.data.user,
        hasSession: !!registerResponse.data.session
      });
      expect(registerResponse.status).toBe(201);
      expect(registerResponse.data.token).toBeDefined();
      expect(registerResponse.data.user).toBeDefined();
      expect(registerResponse.data.session).toBeDefined();
      jwtToken = registerResponse.data.token;
      csrfToken = registerResponse.data.session.csrfToken;
      sessionId = registerResponse.data.session.id;
      console.log('✅ Registration successful:', {
        userId: registerResponse.data.user.id,
        nickname: registerResponse.data.user.nickname,
        sessionId: sessionId,
        loginTime: registerResponse.data.session.loginTime
      });

      // Wait a moment for logs to appear
      await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
      console.error('❌ Registration failed:', error.response?.data || error.message);
      throw error;
    }
  });
  it('2. Check session persistence - same session across multiple requests', async () => {
    console.log('🧪 TEST 2: Testing session persistence between requests...');
    try {
      // Set authorization header for subsequent requests
      ioClient.defaults.headers.common['Authorization'] = `Bearer ${jwtToken}`;

      // Make first request - should use existing session
      console.log('🌐 Making first API request (users list)...');
      const firstResponse = await ioClient.get('/api/users');
      expect(firstResponse.status).toBe(200);
      console.log('✅ First request successful');

      // Wait a moment
      await new Promise(resolve => setTimeout(resolve, 500));

      // Make second request - should reuse same session
      console.log('🌐 Making second API request (channels list)...');
      const secondResponse = await ioClient.get('/api/channels');
      expect(secondResponse.status).toBe(200);
      console.log('✅ Second request successful');
      console.log('🔄 Both requests should have used the same persistent session');
    } catch (error) {
      console.error('❌ Session persistence test failed:', error.response?.data || error.message);
      throw error;
    }
  });
  it('3. Test Socket.IO authentication with session fingerprint', async () => {
    console.log('🧪 TEST 3: Testing Socket.IO authentication with session fingerprint...');
    try {
      // Connect to Socket.IO with session data
      socket = io.connect(BASE_URL, {
        forceNew: true,
        transports: ['websocket', 'polling'],
        auth: {
          csrfToken: csrfToken
        },
        extraHeaders: {
          cookie: ioClient.defaults.headers?.cookie
        }
      });

      // Wait for connection
      await new Promise((resolve, reject) => {
        socket.on('connect', () => {
          console.log('🔌 Socket connected successfully');
          console.log('🎉 Socket fingerprint authentication successful with CSRF token');
          resolve();
        });
        socket.on('connect_error', error => {
          console.error('❌ Socket connection failed:', error.message);
          reject(error);
        });

        // Timeout after 10 seconds
        setTimeout(() => {
          reject(new Error('Socket connection timeout'));
        }, 10000);
      });
    } catch (error) {
      console.error('❌ Socket.IO authentication test failed:', error.message);
      throw error;
    }
  });
  it('4. Test session logout persistence', async () => {
    console.log('🧪 TEST 4: Testing session logout and cleanup...');
    try {
      // Logout
      const logoutResponse = await ioClient.post('/api/logout_complete');
      expect(logoutResponse.status).toBe(200);
      console.log('🚪 Complete logout successful:', logoutResponse.data);

      // Socket should be disconnected after logout
      socket.disconnect();
      console.log('🔌 Socket disconnected after logout');
    } catch (error) {
      console.error('❌ Session logout test failed:', error.response?.data || error.message);
      throw error;
    }
  });
  it('5. Test session persistence after logout - new session should be created', async () => {
    console.log('🧪 TEST 5: Testing that logout properly clears session and new login creates new session...');
    try {
      // Try to login again - should create new session
      const loginResponse = await ioClient.post('/api/login', {
        identifier: testUser.email,
        password: testUser.password
      });
      expect(loginResponse.status).toBe(200);
      const newSessionId = loginResponse.data.session.id;
      console.log('🔑 Second login successful:', {
        originalSessionId: sessionId,
        newSessionId: newSessionId,
        sessionsDifferent: sessionId !== newSessionId
      });

      // Sessions should be different
      expect(sessionId).not.toBe(newSessionId);
      console.log('✅ Session lifecycle complete: logout cleared session, new login created new session');
    } catch (error) {
      console.error('❌ New session creation test failed:', error.response?.data || error.message);
      throw error;
    }
  });
  afterAll(async () => {
    if (socket && socket.connected) {
      socket.disconnect();
    }
  });
});
module.exports = {
  describe,
  it
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpbyIsInJlcXVpcmUiLCJheGlvcyIsImV4cGVjdCIsIkJBU0VfVVJMIiwiaW9DbGllbnQiLCJjcmVhdGUiLCJiYXNlVVJMIiwid2l0aENyZWRlbnRpYWxzIiwiaGVhZGVycyIsImRlc2NyaWJlIiwidGVzdFVzZXIiLCJqd3RUb2tlbiIsImNzcmZUb2tlbiIsInNlc3Npb25JZCIsInNvY2tldCIsImJlZm9yZUFsbCIsIm5pY2tuYW1lIiwiRGF0ZSIsIm5vdyIsImVtYWlsIiwicGFzc3dvcmQiLCJpdCIsImNvbnNvbGUiLCJsb2ciLCJyZWdpc3RlclJlc3BvbnNlIiwicG9zdCIsInN0YXR1cyIsImhhc1Rva2VuIiwiZGF0YSIsInRva2VuIiwiaGFzVXNlciIsInVzZXIiLCJoYXNTZXNzaW9uIiwic2Vzc2lvbiIsInRvQmUiLCJ0b0JlRGVmaW5lZCIsImlkIiwidXNlcklkIiwibG9naW5UaW1lIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwiZXJyb3IiLCJyZXNwb25zZSIsIm1lc3NhZ2UiLCJkZWZhdWx0cyIsImNvbW1vbiIsImZpcnN0UmVzcG9uc2UiLCJnZXQiLCJzZWNvbmRSZXNwb25zZSIsImNvbm5lY3QiLCJmb3JjZU5ldyIsInRyYW5zcG9ydHMiLCJhdXRoIiwiZXh0cmFIZWFkZXJzIiwiY29va2llIiwicmVqZWN0Iiwib24iLCJFcnJvciIsImxvZ291dFJlc3BvbnNlIiwiZGlzY29ubmVjdCIsImxvZ2luUmVzcG9uc2UiLCJpZGVudGlmaWVyIiwibmV3U2Vzc2lvbklkIiwib3JpZ2luYWxTZXNzaW9uSWQiLCJzZXNzaW9uc0RpZmZlcmVudCIsIm5vdCIsImFmdGVyQWxsIiwiY29ubmVjdGVkIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInNlc3Npb24tcGVyc2lzdGVuY2UudGVzdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBpbyA9IHJlcXVpcmUoJ3NvY2tldC5pby1jbGllbnQnKTtcbmNvbnN0IGF4aW9zID0gcmVxdWlyZSgnYXhpb3MnKTtcbmNvbnN0IHsgZXhwZWN0IH0gPSByZXF1aXJlKCdleHBlY3QnKTsgLy8gSmVzdCBleHBlY3RcblxuY29uc3QgQkFTRV9VUkwgPSAnaHR0cDovL2xvY2FsaG9zdDozMDAxJztcbmNvbnN0IGlvQ2xpZW50ID0gYXhpb3MuY3JlYXRlKHtcbiAgYmFzZVVSTDogQkFTRV9VUkwsXG4gIHdpdGhDcmVkZW50aWFsczogdHJ1ZSxcbiAgaGVhZGVyczoge1xuICAgICdVc2VyLUFnZW50JzogJ1Nlc3Npb24tVGVzdC1BZ2VudC8xLjAnXG4gIH1cbn0pO1xuXG5kZXNjcmliZSgnU2Vzc2lvbiBQZXJzaXN0ZW5jZSBGdWxsIEN5Y2xlIFRlc3QnLCAoKSA9PiB7XG4gIGxldCB0ZXN0VXNlcjtcbiAgbGV0IGp3dFRva2VuO1xuICBsZXQgY3NyZlRva2VuO1xuICBsZXQgc2Vzc2lvbklkO1xuICBsZXQgc29ja2V0O1xuXG4gIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgdGVzdFVzZXIgPSB7XG4gICAgICBuaWNrbmFtZTogYHRlc3R1c2VyXyR7RGF0ZS5ub3coKX1gLFxuICAgICAgZW1haWw6IGB0ZXN0XyR7RGF0ZS5ub3coKX1AZXhhbXBsZS5jb21gLFxuICAgICAgcGFzc3dvcmQ6ICdUZXN0UGFzczEyMyEnXG4gICAgfTtcbiAgfSk7XG5cbiAgaXQoJzEuIFJlZ2lzdGVyIG5ldyB1c2VyIGFuZCBjaGVjayBzZXNzaW9uIGNyZWF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCfwn6eqIFRFU1QgMTogU3RhcnRpbmcgdXNlciByZWdpc3RyYXRpb24uLi4nKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZWdpc3RlclJlc3BvbnNlID0gYXdhaXQgaW9DbGllbnQucG9zdCgnL2FwaS9yZWdpc3RlcicsIHRlc3RVc2VyKTtcbiAgICAgIGNvbnNvbGUubG9nKCfwn5OlIFJlZ2lzdHJhdGlvbiByZXNwb25zZTonLCB7XG4gICAgICAgIHN0YXR1czogcmVnaXN0ZXJSZXNwb25zZS5zdGF0dXMsXG4gICAgICAgIGhhc1Rva2VuOiAhIXJlZ2lzdGVyUmVzcG9uc2UuZGF0YS50b2tlbixcbiAgICAgICAgaGFzVXNlcjogISFyZWdpc3RlclJlc3BvbnNlLmRhdGEudXNlcixcbiAgICAgICAgaGFzU2Vzc2lvbjogISFyZWdpc3RlclJlc3BvbnNlLmRhdGEuc2Vzc2lvblxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZWdpc3RlclJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDEpO1xuICAgICAgZXhwZWN0KHJlZ2lzdGVyUmVzcG9uc2UuZGF0YS50b2tlbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZWdpc3RlclJlc3BvbnNlLmRhdGEudXNlcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZWdpc3RlclJlc3BvbnNlLmRhdGEuc2Vzc2lvbikudG9CZURlZmluZWQoKTtcblxuICAgICAgand0VG9rZW4gPSByZWdpc3RlclJlc3BvbnNlLmRhdGEudG9rZW47XG4gICAgICBjc3JmVG9rZW4gPSByZWdpc3RlclJlc3BvbnNlLmRhdGEuc2Vzc2lvbi5jc3JmVG9rZW47XG4gICAgICBzZXNzaW9uSWQgPSByZWdpc3RlclJlc3BvbnNlLmRhdGEuc2Vzc2lvbi5pZDtcblxuICAgICAgY29uc29sZS5sb2coJ+KchSBSZWdpc3RyYXRpb24gc3VjY2Vzc2Z1bDonLCB7XG4gICAgICAgIHVzZXJJZDogcmVnaXN0ZXJSZXNwb25zZS5kYXRhLnVzZXIuaWQsXG4gICAgICAgIG5pY2tuYW1lOiByZWdpc3RlclJlc3BvbnNlLmRhdGEudXNlci5uaWNrbmFtZSxcbiAgICAgICAgc2Vzc2lvbklkOiBzZXNzaW9uSWQsXG4gICAgICAgIGxvZ2luVGltZTogcmVnaXN0ZXJSZXNwb25zZS5kYXRhLnNlc3Npb24ubG9naW5UaW1lXG4gICAgICB9KTtcblxuICAgICAgLy8gV2FpdCBhIG1vbWVudCBmb3IgbG9ncyB0byBhcHBlYXJcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDAwKSk7XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcign4p2MIFJlZ2lzdHJhdGlvbiBmYWlsZWQ6JywgZXJyb3IucmVzcG9uc2U/LmRhdGEgfHwgZXJyb3IubWVzc2FnZSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH0pO1xuXG4gIGl0KCcyLiBDaGVjayBzZXNzaW9uIHBlcnNpc3RlbmNlIC0gc2FtZSBzZXNzaW9uIGFjcm9zcyBtdWx0aXBsZSByZXF1ZXN0cycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zb2xlLmxvZygn8J+nqiBURVNUIDI6IFRlc3Rpbmcgc2Vzc2lvbiBwZXJzaXN0ZW5jZSBiZXR3ZWVuIHJlcXVlc3RzLi4uJyk7XG5cbiAgICB0cnkge1xuICAgICAgLy8gU2V0IGF1dGhvcml6YXRpb24gaGVhZGVyIGZvciBzdWJzZXF1ZW50IHJlcXVlc3RzXG4gICAgICBpb0NsaWVudC5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vblsnQXV0aG9yaXphdGlvbiddID0gYEJlYXJlciAke2p3dFRva2VufWA7XG5cbiAgICAgIC8vIE1ha2UgZmlyc3QgcmVxdWVzdCAtIHNob3VsZCB1c2UgZXhpc3Rpbmcgc2Vzc2lvblxuICAgICAgY29uc29sZS5sb2coJ/CfjJAgTWFraW5nIGZpcnN0IEFQSSByZXF1ZXN0ICh1c2VycyBsaXN0KS4uLicpO1xuICAgICAgY29uc3QgZmlyc3RSZXNwb25zZSA9IGF3YWl0IGlvQ2xpZW50LmdldCgnL2FwaS91c2VycycpO1xuICAgICAgZXhwZWN0KGZpcnN0UmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG5cbiAgICAgIGNvbnNvbGUubG9nKCfinIUgRmlyc3QgcmVxdWVzdCBzdWNjZXNzZnVsJyk7XG5cbiAgICAgIC8vIFdhaXQgYSBtb21lbnRcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MDApKTtcblxuICAgICAgLy8gTWFrZSBzZWNvbmQgcmVxdWVzdCAtIHNob3VsZCByZXVzZSBzYW1lIHNlc3Npb25cbiAgICAgIGNvbnNvbGUubG9nKCfwn4yQIE1ha2luZyBzZWNvbmQgQVBJIHJlcXVlc3QgKGNoYW5uZWxzIGxpc3QpLi4uJyk7XG4gICAgICBjb25zdCBzZWNvbmRSZXNwb25zZSA9IGF3YWl0IGlvQ2xpZW50LmdldCgnL2FwaS9jaGFubmVscycpO1xuICAgICAgZXhwZWN0KHNlY29uZFJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuXG4gICAgICBjb25zb2xlLmxvZygn4pyFIFNlY29uZCByZXF1ZXN0IHN1Y2Nlc3NmdWwnKTtcbiAgICAgIGNvbnNvbGUubG9nKCfwn5SEIEJvdGggcmVxdWVzdHMgc2hvdWxkIGhhdmUgdXNlZCB0aGUgc2FtZSBwZXJzaXN0ZW50IHNlc3Npb24nKTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgU2Vzc2lvbiBwZXJzaXN0ZW5jZSB0ZXN0IGZhaWxlZDonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfSk7XG5cbiAgaXQoJzMuIFRlc3QgU29ja2V0LklPIGF1dGhlbnRpY2F0aW9uIHdpdGggc2Vzc2lvbiBmaW5nZXJwcmludCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zb2xlLmxvZygn8J+nqiBURVNUIDM6IFRlc3RpbmcgU29ja2V0LklPIGF1dGhlbnRpY2F0aW9uIHdpdGggc2Vzc2lvbiBmaW5nZXJwcmludC4uLicpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENvbm5lY3QgdG8gU29ja2V0LklPIHdpdGggc2Vzc2lvbiBkYXRhXG4gICAgICBzb2NrZXQgPSBpby5jb25uZWN0KEJBU0VfVVJMLCB7XG4gICAgICAgIGZvcmNlTmV3OiB0cnVlLFxuICAgICAgICB0cmFuc3BvcnRzOiBbJ3dlYnNvY2tldCcsICdwb2xsaW5nJ10sXG4gICAgICAgIGF1dGg6IHtcbiAgICAgICAgICBjc3JmVG9rZW46IGNzcmZUb2tlblxuICAgICAgICB9LFxuICAgICAgICBleHRyYUhlYWRlcnM6IHtcbiAgICAgICAgICBjb29raWU6IGlvQ2xpZW50LmRlZmF1bHRzLmhlYWRlcnM/LmNvb2tpZVxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgLy8gV2FpdCBmb3IgY29ubmVjdGlvblxuICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBzb2NrZXQub24oJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ/CflIwgU29ja2V0IGNvbm5lY3RlZCBzdWNjZXNzZnVsbHknKTtcbiAgICAgICAgICBjb25zb2xlLmxvZygn8J+OiSBTb2NrZXQgZmluZ2VycHJpbnQgYXV0aGVudGljYXRpb24gc3VjY2Vzc2Z1bCB3aXRoIENTUkYgdG9rZW4nKTtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNvY2tldC5vbignY29ubmVjdF9lcnJvcicsIChlcnJvcikgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBTb2NrZXQgY29ubmVjdGlvbiBmYWlsZWQ6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVGltZW91dCBhZnRlciAxMCBzZWNvbmRzXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ1NvY2tldCBjb25uZWN0aW9uIHRpbWVvdXQnKSk7XG4gICAgICAgIH0sIDEwMDAwKTtcbiAgICAgIH0pO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBTb2NrZXQuSU8gYXV0aGVudGljYXRpb24gdGVzdCBmYWlsZWQ6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH0pO1xuXG4gIGl0KCc0LiBUZXN0IHNlc3Npb24gbG9nb3V0IHBlcnNpc3RlbmNlJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCfwn6eqIFRFU1QgNDogVGVzdGluZyBzZXNzaW9uIGxvZ291dCBhbmQgY2xlYW51cC4uLicpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIExvZ291dFxuICAgICAgY29uc3QgbG9nb3V0UmVzcG9uc2UgPSBhd2FpdCBpb0NsaWVudC5wb3N0KCcvYXBpL2xvZ291dF9jb21wbGV0ZScpO1xuICAgICAgZXhwZWN0KGxvZ291dFJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuXG4gICAgICBjb25zb2xlLmxvZygn8J+aqiBDb21wbGV0ZSBsb2dvdXQgc3VjY2Vzc2Z1bDonLCBsb2dvdXRSZXNwb25zZS5kYXRhKTtcblxuICAgICAgLy8gU29ja2V0IHNob3VsZCBiZSBkaXNjb25uZWN0ZWQgYWZ0ZXIgbG9nb3V0XG4gICAgICBzb2NrZXQuZGlzY29ubmVjdCgpO1xuICAgICAgY29uc29sZS5sb2coJ/CflIwgU29ja2V0IGRpc2Nvbm5lY3RlZCBhZnRlciBsb2dvdXQnKTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgU2Vzc2lvbiBsb2dvdXQgdGVzdCBmYWlsZWQ6JywgZXJyb3IucmVzcG9uc2U/LmRhdGEgfHwgZXJyb3IubWVzc2FnZSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH0pO1xuXG4gIGl0KCc1LiBUZXN0IHNlc3Npb24gcGVyc2lzdGVuY2UgYWZ0ZXIgbG9nb3V0IC0gbmV3IHNlc3Npb24gc2hvdWxkIGJlIGNyZWF0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ/Cfp6ogVEVTVCA1OiBUZXN0aW5nIHRoYXQgbG9nb3V0IHByb3Blcmx5IGNsZWFycyBzZXNzaW9uIGFuZCBuZXcgbG9naW4gY3JlYXRlcyBuZXcgc2Vzc2lvbi4uLicpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFRyeSB0byBsb2dpbiBhZ2FpbiAtIHNob3VsZCBjcmVhdGUgbmV3IHNlc3Npb25cbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCBpb0NsaWVudC5wb3N0KCcvYXBpL2xvZ2luJywge1xuICAgICAgICBpZGVudGlmaWVyOiB0ZXN0VXNlci5lbWFpbCxcbiAgICAgICAgcGFzc3dvcmQ6IHRlc3RVc2VyLnBhc3N3b3JkXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KGxvZ2luUmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG5cbiAgICAgIGNvbnN0IG5ld1Nlc3Npb25JZCA9IGxvZ2luUmVzcG9uc2UuZGF0YS5zZXNzaW9uLmlkO1xuXG4gICAgICBjb25zb2xlLmxvZygn8J+UkSBTZWNvbmQgbG9naW4gc3VjY2Vzc2Z1bDonLCB7XG4gICAgICAgIG9yaWdpbmFsU2Vzc2lvbklkOiBzZXNzaW9uSWQsXG4gICAgICAgIG5ld1Nlc3Npb25JZDogbmV3U2Vzc2lvbklkLFxuICAgICAgICBzZXNzaW9uc0RpZmZlcmVudDogc2Vzc2lvbklkICE9PSBuZXdTZXNzaW9uSWRcbiAgICAgIH0pO1xuXG4gICAgICAvLyBTZXNzaW9ucyBzaG91bGQgYmUgZGlmZmVyZW50XG4gICAgICBleHBlY3Qoc2Vzc2lvbklkKS5ub3QudG9CZShuZXdTZXNzaW9uSWQpO1xuXG4gICAgICBjb25zb2xlLmxvZygn4pyFIFNlc3Npb24gbGlmZWN5Y2xlIGNvbXBsZXRlOiBsb2dvdXQgY2xlYXJlZCBzZXNzaW9uLCBuZXcgbG9naW4gY3JlYXRlZCBuZXcgc2Vzc2lvbicpO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBOZXcgc2Vzc2lvbiBjcmVhdGlvbiB0ZXN0IGZhaWxlZDonLCBlcnJvci5yZXNwb25zZT8uZGF0YSB8fCBlcnJvci5tZXNzYWdlKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGlmIChzb2NrZXQgJiYgc29ja2V0LmNvbm5lY3RlZCkge1xuICAgICAgc29ja2V0LmRpc2Nvbm5lY3QoKTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbm1vZHVsZS5leHBvcnRzID0geyBkZXNjcmliZSwgaXQgfTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLGtCQUFrQixDQUFDO0FBQ3RDLE1BQU1DLEtBQUssR0FBR0QsT0FBTyxDQUFDLE9BQU8sQ0FBQztBQUM5QixNQUFNO0VBQUVFO0FBQU8sQ0FBQyxHQUFHRixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzs7QUFFdEMsTUFBTUcsUUFBUSxHQUFHLHVCQUF1QjtBQUN4QyxNQUFNQyxRQUFRLEdBQUdILEtBQUssQ0FBQ0ksTUFBTSxDQUFDO0VBQzVCQyxPQUFPLEVBQUVILFFBQVE7RUFDakJJLGVBQWUsRUFBRSxJQUFJO0VBQ3JCQyxPQUFPLEVBQUU7SUFDUCxZQUFZLEVBQUU7RUFDaEI7QUFDRixDQUFDLENBQUM7QUFFRkMsUUFBUSxDQUFDLHFDQUFxQyxFQUFFLE1BQU07RUFDcEQsSUFBSUMsUUFBUTtFQUNaLElBQUlDLFFBQVE7RUFDWixJQUFJQyxTQUFTO0VBQ2IsSUFBSUMsU0FBUztFQUNiLElBQUlDLE1BQU07RUFFVkMsU0FBUyxDQUFDLE1BQU07SUFDZEwsUUFBUSxHQUFHO01BQ1RNLFFBQVEsRUFBRSxZQUFZQyxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7TUFDbENDLEtBQUssRUFBRSxRQUFRRixJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDLGNBQWM7TUFDdkNFLFFBQVEsRUFBRTtJQUNaLENBQUM7RUFDSCxDQUFDLENBQUM7RUFFRkMsRUFBRSxDQUFDLGlEQUFpRCxFQUFFLFlBQVk7SUFDaEVDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLDBDQUEwQyxDQUFDO0lBRXZELElBQUk7TUFDRixNQUFNQyxnQkFBZ0IsR0FBRyxNQUFNcEIsUUFBUSxDQUFDcUIsSUFBSSxDQUFDLGVBQWUsRUFBRWYsUUFBUSxDQUFDO01BQ3ZFWSxPQUFPLENBQUNDLEdBQUcsQ0FBQywyQkFBMkIsRUFBRTtRQUN2Q0csTUFBTSxFQUFFRixnQkFBZ0IsQ0FBQ0UsTUFBTTtRQUMvQkMsUUFBUSxFQUFFLENBQUMsQ0FBQ0gsZ0JBQWdCLENBQUNJLElBQUksQ0FBQ0MsS0FBSztRQUN2Q0MsT0FBTyxFQUFFLENBQUMsQ0FBQ04sZ0JBQWdCLENBQUNJLElBQUksQ0FBQ0csSUFBSTtRQUNyQ0MsVUFBVSxFQUFFLENBQUMsQ0FBQ1IsZ0JBQWdCLENBQUNJLElBQUksQ0FBQ0s7TUFDdEMsQ0FBQyxDQUFDO01BRUYvQixNQUFNLENBQUNzQixnQkFBZ0IsQ0FBQ0UsTUFBTSxDQUFDLENBQUNRLElBQUksQ0FBQyxHQUFHLENBQUM7TUFDekNoQyxNQUFNLENBQUNzQixnQkFBZ0IsQ0FBQ0ksSUFBSSxDQUFDQyxLQUFLLENBQUMsQ0FBQ00sV0FBVyxDQUFDLENBQUM7TUFDakRqQyxNQUFNLENBQUNzQixnQkFBZ0IsQ0FBQ0ksSUFBSSxDQUFDRyxJQUFJLENBQUMsQ0FBQ0ksV0FBVyxDQUFDLENBQUM7TUFDaERqQyxNQUFNLENBQUNzQixnQkFBZ0IsQ0FBQ0ksSUFBSSxDQUFDSyxPQUFPLENBQUMsQ0FBQ0UsV0FBVyxDQUFDLENBQUM7TUFFbkR4QixRQUFRLEdBQUdhLGdCQUFnQixDQUFDSSxJQUFJLENBQUNDLEtBQUs7TUFDdENqQixTQUFTLEdBQUdZLGdCQUFnQixDQUFDSSxJQUFJLENBQUNLLE9BQU8sQ0FBQ3JCLFNBQVM7TUFDbkRDLFNBQVMsR0FBR1csZ0JBQWdCLENBQUNJLElBQUksQ0FBQ0ssT0FBTyxDQUFDRyxFQUFFO01BRTVDZCxPQUFPLENBQUNDLEdBQUcsQ0FBQyw0QkFBNEIsRUFBRTtRQUN4Q2MsTUFBTSxFQUFFYixnQkFBZ0IsQ0FBQ0ksSUFBSSxDQUFDRyxJQUFJLENBQUNLLEVBQUU7UUFDckNwQixRQUFRLEVBQUVRLGdCQUFnQixDQUFDSSxJQUFJLENBQUNHLElBQUksQ0FBQ2YsUUFBUTtRQUM3Q0gsU0FBUyxFQUFFQSxTQUFTO1FBQ3BCeUIsU0FBUyxFQUFFZCxnQkFBZ0IsQ0FBQ0ksSUFBSSxDQUFDSyxPQUFPLENBQUNLO01BQzNDLENBQUMsQ0FBQzs7TUFFRjtNQUNBLE1BQU0sSUFBSUMsT0FBTyxDQUFDQyxPQUFPLElBQUlDLFVBQVUsQ0FBQ0QsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRXpELENBQUMsQ0FBQyxPQUFPRSxLQUFLLEVBQUU7TUFDZHBCLE9BQU8sQ0FBQ29CLEtBQUssQ0FBQyx3QkFBd0IsRUFBRUEsS0FBSyxDQUFDQyxRQUFRLEVBQUVmLElBQUksSUFBSWMsS0FBSyxDQUFDRSxPQUFPLENBQUM7TUFDOUUsTUFBTUYsS0FBSztJQUNiO0VBQ0YsQ0FBQyxDQUFDO0VBRUZyQixFQUFFLENBQUMsc0VBQXNFLEVBQUUsWUFBWTtJQUNyRkMsT0FBTyxDQUFDQyxHQUFHLENBQUMsNERBQTRELENBQUM7SUFFekUsSUFBSTtNQUNGO01BQ0FuQixRQUFRLENBQUN5QyxRQUFRLENBQUNyQyxPQUFPLENBQUNzQyxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsVUFBVW5DLFFBQVEsRUFBRTs7TUFFeEU7TUFDQVcsT0FBTyxDQUFDQyxHQUFHLENBQUMsNkNBQTZDLENBQUM7TUFDMUQsTUFBTXdCLGFBQWEsR0FBRyxNQUFNM0MsUUFBUSxDQUFDNEMsR0FBRyxDQUFDLFlBQVksQ0FBQztNQUN0RDlDLE1BQU0sQ0FBQzZDLGFBQWEsQ0FBQ3JCLE1BQU0sQ0FBQyxDQUFDUSxJQUFJLENBQUMsR0FBRyxDQUFDO01BRXRDWixPQUFPLENBQUNDLEdBQUcsQ0FBQyw0QkFBNEIsQ0FBQzs7TUFFekM7TUFDQSxNQUFNLElBQUlnQixPQUFPLENBQUNDLE9BQU8sSUFBSUMsVUFBVSxDQUFDRCxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7O01BRXREO01BQ0FsQixPQUFPLENBQUNDLEdBQUcsQ0FBQyxpREFBaUQsQ0FBQztNQUM5RCxNQUFNMEIsY0FBYyxHQUFHLE1BQU03QyxRQUFRLENBQUM0QyxHQUFHLENBQUMsZUFBZSxDQUFDO01BQzFEOUMsTUFBTSxDQUFDK0MsY0FBYyxDQUFDdkIsTUFBTSxDQUFDLENBQUNRLElBQUksQ0FBQyxHQUFHLENBQUM7TUFFdkNaLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLDZCQUE2QixDQUFDO01BQzFDRCxPQUFPLENBQUNDLEdBQUcsQ0FBQywrREFBK0QsQ0FBQztJQUU5RSxDQUFDLENBQUMsT0FBT21CLEtBQUssRUFBRTtNQUNkcEIsT0FBTyxDQUFDb0IsS0FBSyxDQUFDLG9DQUFvQyxFQUFFQSxLQUFLLENBQUNDLFFBQVEsRUFBRWYsSUFBSSxJQUFJYyxLQUFLLENBQUNFLE9BQU8sQ0FBQztNQUMxRixNQUFNRixLQUFLO0lBQ2I7RUFDRixDQUFDLENBQUM7RUFFRnJCLEVBQUUsQ0FBQywyREFBMkQsRUFBRSxZQUFZO0lBQzFFQyxPQUFPLENBQUNDLEdBQUcsQ0FBQyx5RUFBeUUsQ0FBQztJQUV0RixJQUFJO01BQ0Y7TUFDQVQsTUFBTSxHQUFHZixFQUFFLENBQUNtRCxPQUFPLENBQUMvQyxRQUFRLEVBQUU7UUFDNUJnRCxRQUFRLEVBQUUsSUFBSTtRQUNkQyxVQUFVLEVBQUUsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDO1FBQ3BDQyxJQUFJLEVBQUU7VUFDSnpDLFNBQVMsRUFBRUE7UUFDYixDQUFDO1FBQ0QwQyxZQUFZLEVBQUU7VUFDWkMsTUFBTSxFQUFFbkQsUUFBUSxDQUFDeUMsUUFBUSxDQUFDckMsT0FBTyxFQUFFK0M7UUFDckM7TUFDRixDQUFDLENBQUM7O01BRUY7TUFDQSxNQUFNLElBQUloQixPQUFPLENBQUMsQ0FBQ0MsT0FBTyxFQUFFZ0IsTUFBTSxLQUFLO1FBQ3JDMUMsTUFBTSxDQUFDMkMsRUFBRSxDQUFDLFNBQVMsRUFBRSxNQUFNO1VBQ3pCbkMsT0FBTyxDQUFDQyxHQUFHLENBQUMsa0NBQWtDLENBQUM7VUFDL0NELE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLGlFQUFpRSxDQUFDO1VBQzlFaUIsT0FBTyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUM7UUFFRjFCLE1BQU0sQ0FBQzJDLEVBQUUsQ0FBQyxlQUFlLEVBQUdmLEtBQUssSUFBSztVQUNwQ3BCLE9BQU8sQ0FBQ29CLEtBQUssQ0FBQyw2QkFBNkIsRUFBRUEsS0FBSyxDQUFDRSxPQUFPLENBQUM7VUFDM0RZLE1BQU0sQ0FBQ2QsS0FBSyxDQUFDO1FBQ2YsQ0FBQyxDQUFDOztRQUVGO1FBQ0FELFVBQVUsQ0FBQyxNQUFNO1VBQ2ZlLE1BQU0sQ0FBQyxJQUFJRSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztRQUNoRCxDQUFDLEVBQUUsS0FBSyxDQUFDO01BQ1gsQ0FBQyxDQUFDO0lBRUosQ0FBQyxDQUFDLE9BQU9oQixLQUFLLEVBQUU7TUFDZHBCLE9BQU8sQ0FBQ29CLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRUEsS0FBSyxDQUFDRSxPQUFPLENBQUM7TUFDdkUsTUFBTUYsS0FBSztJQUNiO0VBQ0YsQ0FBQyxDQUFDO0VBRUZyQixFQUFFLENBQUMsb0NBQW9DLEVBQUUsWUFBWTtJQUNuREMsT0FBTyxDQUFDQyxHQUFHLENBQUMsa0RBQWtELENBQUM7SUFFL0QsSUFBSTtNQUNGO01BQ0EsTUFBTW9DLGNBQWMsR0FBRyxNQUFNdkQsUUFBUSxDQUFDcUIsSUFBSSxDQUFDLHNCQUFzQixDQUFDO01BQ2xFdkIsTUFBTSxDQUFDeUQsY0FBYyxDQUFDakMsTUFBTSxDQUFDLENBQUNRLElBQUksQ0FBQyxHQUFHLENBQUM7TUFFdkNaLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLGdDQUFnQyxFQUFFb0MsY0FBYyxDQUFDL0IsSUFBSSxDQUFDOztNQUVsRTtNQUNBZCxNQUFNLENBQUM4QyxVQUFVLENBQUMsQ0FBQztNQUNuQnRDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLHFDQUFxQyxDQUFDO0lBRXBELENBQUMsQ0FBQyxPQUFPbUIsS0FBSyxFQUFFO01BQ2RwQixPQUFPLENBQUNvQixLQUFLLENBQUMsK0JBQStCLEVBQUVBLEtBQUssQ0FBQ0MsUUFBUSxFQUFFZixJQUFJLElBQUljLEtBQUssQ0FBQ0UsT0FBTyxDQUFDO01BQ3JGLE1BQU1GLEtBQUs7SUFDYjtFQUNGLENBQUMsQ0FBQztFQUVGckIsRUFBRSxDQUFDLDBFQUEwRSxFQUFFLFlBQVk7SUFDekZDLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDLDZGQUE2RixDQUFDO0lBRTFHLElBQUk7TUFDRjtNQUNBLE1BQU1zQyxhQUFhLEdBQUcsTUFBTXpELFFBQVEsQ0FBQ3FCLElBQUksQ0FBQyxZQUFZLEVBQUU7UUFDdERxQyxVQUFVLEVBQUVwRCxRQUFRLENBQUNTLEtBQUs7UUFDMUJDLFFBQVEsRUFBRVYsUUFBUSxDQUFDVTtNQUNyQixDQUFDLENBQUM7TUFFRmxCLE1BQU0sQ0FBQzJELGFBQWEsQ0FBQ25DLE1BQU0sQ0FBQyxDQUFDUSxJQUFJLENBQUMsR0FBRyxDQUFDO01BRXRDLE1BQU02QixZQUFZLEdBQUdGLGFBQWEsQ0FBQ2pDLElBQUksQ0FBQ0ssT0FBTyxDQUFDRyxFQUFFO01BRWxEZCxPQUFPLENBQUNDLEdBQUcsQ0FBQyw2QkFBNkIsRUFBRTtRQUN6Q3lDLGlCQUFpQixFQUFFbkQsU0FBUztRQUM1QmtELFlBQVksRUFBRUEsWUFBWTtRQUMxQkUsaUJBQWlCLEVBQUVwRCxTQUFTLEtBQUtrRDtNQUNuQyxDQUFDLENBQUM7O01BRUY7TUFDQTdELE1BQU0sQ0FBQ1csU0FBUyxDQUFDLENBQUNxRCxHQUFHLENBQUNoQyxJQUFJLENBQUM2QixZQUFZLENBQUM7TUFFeEN6QyxPQUFPLENBQUNDLEdBQUcsQ0FBQyxxRkFBcUYsQ0FBQztJQUVwRyxDQUFDLENBQUMsT0FBT21CLEtBQUssRUFBRTtNQUNkcEIsT0FBTyxDQUFDb0IsS0FBSyxDQUFDLHFDQUFxQyxFQUFFQSxLQUFLLENBQUNDLFFBQVEsRUFBRWYsSUFBSSxJQUFJYyxLQUFLLENBQUNFLE9BQU8sQ0FBQztNQUMzRixNQUFNRixLQUFLO0lBQ2I7RUFDRixDQUFDLENBQUM7RUFFRnlCLFFBQVEsQ0FBQyxZQUFZO0lBQ25CLElBQUlyRCxNQUFNLElBQUlBLE1BQU0sQ0FBQ3NELFNBQVMsRUFBRTtNQUM5QnRELE1BQU0sQ0FBQzhDLFVBQVUsQ0FBQyxDQUFDO0lBQ3JCO0VBQ0YsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBRUZTLE1BQU0sQ0FBQ0MsT0FBTyxHQUFHO0VBQUU3RCxRQUFRO0VBQUVZO0FBQUcsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==