{"version":3,"names":["cov_1yl4sad7cq","actualCoverage","mongoose","s","require","channelSchema","Schema","id","type","String","required","unique","trim","name","maxlength","parent","default","enum","description","position","Number","createdBy","createdAt","Date","now","updatedAt","permissions","read","write","locked","Boolean","index","pre","next","f","b","isNew","baseId","toLowerCase","replace","Math","random","toString","substr","uniqueId","counter","existing","constructor","findOne","methods","safeDelete","messageCount","model","countDocuments","channel","Error","deleteOne","module","exports"],"sources":["Channel.js"],"sourcesContent":["const mongoose = require('mongoose');\n\nconst channelSchema = new mongoose.Schema({\n  id: {\n    type: String,\n    required: true,\n    unique: true,\n    trim: true\n  },\n  name: {\n    type: String,\n    required: true,\n    trim: true,\n    maxlength: 100\n  },\n  parent: {\n    type: String,\n    default: null\n  },\n  type: {\n    type: String,\n    enum: ['text', 'voice'],\n    required: true\n  },\n  description: {\n    type: String,\n    maxlength: 500\n  },\n  position: {\n    type: Number,\n    default: 0\n  },\n  createdBy: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  createdAt: {\n    type: Date,\n    default: Date.now\n  },\n  updatedAt: {\n    type: Date,\n    default: Date.now\n  },\n  permissions: {\n    read: {\n      type: String,\n      enum: ['everyone', 'admin'],\n      default: 'everyone'\n    },\n    write: {\n      type: String,\n      enum: ['everyone', 'admin'],\n      default: 'everyone'\n    }\n  },\n  locked: {\n    type: Boolean,\n    default: false\n  }\n});\n\n// Indexes\nchannelSchema.index({ id: 1, type: 1 }); // For channel queries by type\nchannelSchema.index({ parent: 1 }); // For nested channels\nchannelSchema.index({ position: 1 }); // For ordering\n\n// Generate unique ID from name and handle slug\nchannelSchema.pre('save', async function(next) {\n  this.updatedAt = new Date();\n\n  if (this.isNew && this.name && !this.id) {\n    // Generate base ID from name\n    let baseId = this.name.toLowerCase()\n      .replace(/[^a-z0-9\\s-]/g, '') // Remove special chars except spaces and hyphens\n      .replace(/\\s+/g, '-') // Replace spaces with hyphens\n      .replace(/-+/g, '-') // Replace multiple hyphens with single\n      .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens\n\n    // Ensure ID is not empty\n    if (!baseId) {\n      baseId = 'channel-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n    }\n\n    // Ensure uniqueness\n    let uniqueId = baseId;\n    let counter = 1;\n    let existing = await this.constructor.findOne({ id: uniqueId });\n\n    while (existing) {\n      uniqueId = `${baseId}-${counter}`;\n      counter++;\n      existing = await this.constructor.findOne({ id: uniqueId });\n    }\n\n    this.id = uniqueId;\n  }\n\n  next();\n});\n\n// Remove channel method (used for deleting with checks)\nchannelSchema.methods.safeDelete = async function() {\n   // Count messages in this channel\n   const messageCount = await mongoose.model('Message').countDocuments({ channel: this.id });\n\n   if (messageCount > 0) {\n     throw new Error(`Cannot delete channel with ${messageCount} messages. Channel must be empty or archived.`);\n   }\n\n   return this.deleteOne();\n};\n\nmodule.exports = mongoose.model('Channel', channelSchema);"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAeY;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAfZ,MAAME,QAAQ;AAAA;AAAA,CAAAF,cAAA,GAAAG,CAAA,OAAGC,OAAO,CAAC,UAAU,CAAC;AAEpC,MAAMC,aAAa;AAAA;AAAA,CAAAL,cAAA,GAAAG,CAAA,OAAG,IAAID,QAAQ,CAACI,MAAM,CAAC;EACxCC,EAAE,EAAE;IACFC,IAAI,EAAEC,MAAM;IACZC,QAAQ,EAAE,IAAI;IACdC,MAAM,EAAE,IAAI;IACZC,IAAI,EAAE;EACR,CAAC;EACDC,IAAI,EAAE;IACJL,IAAI,EAAEC,MAAM;IACZC,QAAQ,EAAE,IAAI;IACdE,IAAI,EAAE,IAAI;IACVE,SAAS,EAAE;EACb,CAAC;EACDC,MAAM,EAAE;IACNP,IAAI,EAAEC,MAAM;IACZO,OAAO,EAAE;EACX,CAAC;EACDR,IAAI,EAAE;IACJA,IAAI,EAAEC,MAAM;IACZQ,IAAI,EAAE,CAAC,MAAM,EAAE,OAAO,CAAC;IACvBP,QAAQ,EAAE;EACZ,CAAC;EACDQ,WAAW,EAAE;IACXV,IAAI,EAAEC,MAAM;IACZK,SAAS,EAAE;EACb,CAAC;EACDK,QAAQ,EAAE;IACRX,IAAI,EAAEY,MAAM;IACZJ,OAAO,EAAE;EACX,CAAC;EACDK,SAAS,EAAE;IACTb,IAAI,EAAEC,MAAM;IACZC,QAAQ,EAAE,IAAI;IACdE,IAAI,EAAE;EACR,CAAC;EACDU,SAAS,EAAE;IACTd,IAAI,EAAEe,IAAI;IACVP,OAAO,EAAEO,IAAI,CAACC;EAChB,CAAC;EACDC,SAAS,EAAE;IACTjB,IAAI,EAAEe,IAAI;IACVP,OAAO,EAAEO,IAAI,CAACC;EAChB,CAAC;EACDE,WAAW,EAAE;IACXC,IAAI,EAAE;MACJnB,IAAI,EAAEC,MAAM;MACZQ,IAAI,EAAE,CAAC,UAAU,EAAE,OAAO,CAAC;MAC3BD,OAAO,EAAE;IACX,CAAC;IACDY,KAAK,EAAE;MACLpB,IAAI,EAAEC,MAAM;MACZQ,IAAI,EAAE,CAAC,UAAU,EAAE,OAAO,CAAC;MAC3BD,OAAO,EAAE;IACX;EACF,CAAC;EACDa,MAAM,EAAE;IACNrB,IAAI,EAAEsB,OAAO;IACbd,OAAO,EAAE;EACX;AACF,CAAC,CAAC;;AAEF;AAAA;AAAAhB,cAAA,GAAAG,CAAA;AACAE,aAAa,CAAC0B,KAAK,CAAC;EAAExB,EAAE,EAAE,CAAC;EAAEC,IAAI,EAAE;AAAE,CAAC,CAAC,CAAC,CAAC;AAAA;AAAAR,cAAA,GAAAG,CAAA;AACzCE,aAAa,CAAC0B,KAAK,CAAC;EAAEhB,MAAM,EAAE;AAAE,CAAC,CAAC,CAAC,CAAC;AAAA;AAAAf,cAAA,GAAAG,CAAA;AACpCE,aAAa,CAAC0B,KAAK,CAAC;EAAEZ,QAAQ,EAAE;AAAE,CAAC,CAAC,CAAC,CAAC;;AAEtC;AAAA;AAAAnB,cAAA,GAAAG,CAAA;AACAE,aAAa,CAAC2B,GAAG,CAAC,MAAM,EAAE,gBAAeC,IAAI,EAAE;EAAA;EAAAjC,cAAA,GAAAkC,CAAA;EAAAlC,cAAA,GAAAG,CAAA;EAC7C,IAAI,CAACsB,SAAS,GAAG,IAAIF,IAAI,CAAC,CAAC;EAAC;EAAAvB,cAAA,GAAAG,CAAA;EAE5B;EAAI;EAAA,CAAAH,cAAA,GAAAmC,CAAA,cAAI,CAACC,KAAK;EAAA;EAAA,CAAApC,cAAA,GAAAmC,CAAA,UAAI,IAAI,CAACtB,IAAI;EAAA;EAAA,CAAAb,cAAA,GAAAmC,CAAA,UAAI,CAAC,IAAI,CAAC5B,EAAE,GAAE;IAAA;IAAAP,cAAA,GAAAmC,CAAA;IACvC;IACA,IAAIE,MAAM;IAAA;IAAA,CAAArC,cAAA,GAAAG,CAAA,OAAG,IAAI,CAACU,IAAI,CAACyB,WAAW,CAAC,CAAC,CACjCC,OAAO,CAAC,eAAe,EAAE,EAAE,CAAC,CAAC;IAAA,CAC7BA,OAAO,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;IAAA,CACrBA,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;IAAA,CACpBA,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,EAAC,CAAC;;IAE1B;IAAA;IAAAvC,cAAA,GAAAG,CAAA;IACA,IAAI,CAACkC,MAAM,EAAE;MAAA;MAAArC,cAAA,GAAAmC,CAAA;MAAAnC,cAAA,GAAAG,CAAA;MACXkC,MAAM,GAAG,UAAU,GAAGd,IAAI,CAACC,GAAG,CAAC,CAAC,GAAG,GAAG,GAAGgB,IAAI,CAACC,MAAM,CAAC,CAAC,CAACC,QAAQ,CAAC,EAAE,CAAC,CAACC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC;IAClF,CAAC;IAAA;IAAA;MAAA3C,cAAA,GAAAmC,CAAA;IAAA;;IAED;IACA,IAAIS,QAAQ;IAAA;IAAA,CAAA5C,cAAA,GAAAG,CAAA,QAAGkC,MAAM;IACrB,IAAIQ,OAAO;IAAA;IAAA,CAAA7C,cAAA,GAAAG,CAAA,QAAG,CAAC;IACf,IAAI2C,QAAQ;IAAA;IAAA,CAAA9C,cAAA,GAAAG,CAAA,QAAG,MAAM,IAAI,CAAC4C,WAAW,CAACC,OAAO,CAAC;MAAEzC,EAAE,EAAEqC;IAAS,CAAC,CAAC;IAAC;IAAA5C,cAAA,GAAAG,CAAA;IAEhE,OAAO2C,QAAQ,EAAE;MAAA;MAAA9C,cAAA,GAAAG,CAAA;MACfyC,QAAQ,GAAG,GAAGP,MAAM,IAAIQ,OAAO,EAAE;MAAC;MAAA7C,cAAA,GAAAG,CAAA;MAClC0C,OAAO,EAAE;MAAC;MAAA7C,cAAA,GAAAG,CAAA;MACV2C,QAAQ,GAAG,MAAM,IAAI,CAACC,WAAW,CAACC,OAAO,CAAC;QAAEzC,EAAE,EAAEqC;MAAS,CAAC,CAAC;IAC7D;IAAC;IAAA5C,cAAA,GAAAG,CAAA;IAED,IAAI,CAACI,EAAE,GAAGqC,QAAQ;EACpB,CAAC;EAAA;EAAA;IAAA5C,cAAA,GAAAmC,CAAA;EAAA;EAAAnC,cAAA,GAAAG,CAAA;EAED8B,IAAI,CAAC,CAAC;AACR,CAAC,CAAC;;AAEF;AAAA;AAAAjC,cAAA,GAAAG,CAAA;AACAE,aAAa,CAAC4C,OAAO,CAACC,UAAU,GAAG,kBAAiB;EAAA;EAAAlD,cAAA,GAAAkC,CAAA;EACjD;EACA,MAAMiB,YAAY;EAAA;EAAA,CAAAnD,cAAA,GAAAG,CAAA,QAAG,MAAMD,QAAQ,CAACkD,KAAK,CAAC,SAAS,CAAC,CAACC,cAAc,CAAC;IAAEC,OAAO,EAAE,IAAI,CAAC/C;EAAG,CAAC,CAAC;EAAC;EAAAP,cAAA,GAAAG,CAAA;EAE1F,IAAIgD,YAAY,GAAG,CAAC,EAAE;IAAA;IAAAnD,cAAA,GAAAmC,CAAA;IAAAnC,cAAA,GAAAG,CAAA;IACpB,MAAM,IAAIoD,KAAK,CAAC,8BAA8BJ,YAAY,+CAA+C,CAAC;EAC5G,CAAC;EAAA;EAAA;IAAAnD,cAAA,GAAAmC,CAAA;EAAA;EAAAnC,cAAA,GAAAG,CAAA;EAED,OAAO,IAAI,CAACqD,SAAS,CAAC,CAAC;AAC1B,CAAC;AAAC;AAAAxD,cAAA,GAAAG,CAAA;AAEFsD,MAAM,CAACC,OAAO,GAAGxD,QAAQ,CAACkD,KAAK,CAAC,SAAS,EAAE/C,aAAa,CAAC","ignoreList":[]}