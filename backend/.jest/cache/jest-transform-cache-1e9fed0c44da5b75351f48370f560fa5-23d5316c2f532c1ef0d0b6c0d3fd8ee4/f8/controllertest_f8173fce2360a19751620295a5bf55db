75baf1d35997be79e7c2605b02d3020b
const request = require('supertest');
const mongoose = require('mongoose');
const {
  MongoMemoryServer
} = require('mongodb-memory-server');
const app = require('../../server');
const User = require('../../models/User');
const Channel = require('../../models/Channel');
let mongoServer;
describe('API Controllers Integration Tests', () => {
  beforeAll(async () => {
    // Start in-memory MongoDB
    mongoServer = await MongoMemoryServer.create();
    const mongoUri = mongoServer.getUri();
    await mongoose.connect(mongoUri);

    // Create default channels
    await Channel.findOneAndUpdate({
      id: 'general'
    }, {
      id: 'general',
      name: 'General',
      type: 'text',
      createdBy: 'system'
    }, {
      upsert: true,
      new: true
    });
  });
  afterAll(async () => {
    await mongoose.disconnect();
    await mongoServer.stop();
  });
  beforeEach(async () => {
    // Clear users but keep channels
    await User.deleteMany({});
  });
  describe('POST /api/register', () => {
    const validUserData = {
      nickname: 'testuser',
      email: 'test@example.com',
      password: 'password123'
    };
    it('should register a new user successfully', async () => {
      const response = await request(app).post('/api/register').send(validUserData).expect(201);
      expect(response.body).toHaveProperty('token');
      expect(response.body).toHaveProperty('user');
      expect(response.body.user.nickname).toBe('testuser');
      expect(response.body.user.email).toBe('test@example.com');
    });
    it('should return 409 for duplicate nickname', async () => {
      // Create existing user
      await new User(validUserData).save();
      const response = await request(app).post('/api/register').send(validUserData).expect(409);
      expect(response.body.error).toContain('already');
    });
    it('should validate nickname length', async () => {
      const shortNickname = {
        ...validUserData,
        nickname: 'ab'
      };
      await request(app).post('/api/register').send(shortNickname).expect(400);
    });
  });
  describe('POST /api/login', () => {
    const userData = {
      nickname: 'loginuser',
      email: 'login@example.com',
      password: 'password123'
    };
    beforeEach(async () => {
      await new User(userData).save();
    });
    it('should login with correct credentials', async () => {
      const response = await request(app).post('/api/login').send({
        identifier: 'loginuser',
        password: 'password123'
      }).expect(200);
      expect(response.body).toHaveProperty('token');
      expect(response.body).toHaveProperty('user');
      expect(response.body.user.nickname).toBe('loginuser');
    });
    it('should login by email', async () => {
      const response = await request(app).post('/api/login').send({
        identifier: 'login@example.com',
        password: 'password123'
      }).expect(200);
      expect(response.body.user.email).toBe('login@example.com');
    });
    it('should return 400 for invalid credentials', async () => {
      await request(app).post('/api/login').send({
        identifier: 'loginuser',
        password: 'wrongpassword'
      }).expect(400);
    });
  });
  describe('GET /api/channels', () => {
    let authToken;
    beforeEach(async () => {
      // Create user for authentication
      const user = await new User({
        nickname: 'channeluser',
        email: 'channel@example.com',
        password: 'password123'
      }).save();

      // Login to get token
      const loginResponse = await request(app).post('/api/login').send({
        identifier: 'channeluser',
        password: 'password123'
      });
      authToken = loginResponse.body.token;

      // Create additional test channel
      await new Channel({
        id: 'testchannel',
        name: 'Test Channel',
        type: 'text',
        createdBy: 'channeluser'
      }).save();
    });
    it('should return channels list for authenticated user', async () => {
      const response = await request(app).get('/api/channels').set('Authorization', `Bearer ${authToken}`).expect(200);
      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.length).toBeGreaterThanOrEqual(2); // At least general + testchannel

      const hasGeneral = response.body.some(ch => ch.id === 'general');
      const hasTestChannel = response.body.some(ch => ch.id === 'testchannel');
      expect(hasGeneral).toBe(true);
      expect(hasTestChannel).toBe(true);
    });
    it('should return 401 without authentication', async () => {
      await request(app).get('/api/channels').expect(401);
    });
    it('should return channels sorted by position', async () => {
      // Create channel with position 0
      await new Channel({
        id: 'pos0',
        name: 'Position 0',
        type: 'text',
        createdBy: 'channeluser',
        position: 0
      }).save();
      const response = await request(app).get('/api/channels').set('Authorization', `Bearer ${authToken}`).expect(200);

      // Find the pos0 channel
      const pos0Channel = response.body.find(ch => ch.id === 'pos0');
      expect(pos0Channel.position).toBe(0);
    });
  });
});
describe('Server Configuration & Middleware', () => {
  test('should have CORS enabled', async () => {
    const response = await request(app).options('/api/health').set('Origin', 'http://localhost:3000').expect(204);
    expect(response.headers['access-control-allow-origin']).toBeDefined();
  });
  test('should have rate limiting configured', async () => {
    const requests = [];
    for (let i = 0; i < 6; i++) {
      requests.push(request(app).post('/api/login').send({
        identifier: 'test',
        password: 'test'
      }));
    }
    const responses = await Promise.all(requests);

    // Some should be rate limited (429)
    const rateLimited = responses.some(resp => resp.status === 429);
    expect(rateLimited).toBe(true);
  });
  test('should serve health check endpoint', async () => {
    const response = await request(app).get('/health').expect(200);
    expect(response.body).toHaveProperty('status', 'healthy');
    expect(response.body).toHaveProperty('uptime');
    expect(response.body).toHaveProperty('timestamp');
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyZXF1ZXN0IiwicmVxdWlyZSIsIm1vbmdvb3NlIiwiTW9uZ29NZW1vcnlTZXJ2ZXIiLCJhcHAiLCJVc2VyIiwiQ2hhbm5lbCIsIm1vbmdvU2VydmVyIiwiZGVzY3JpYmUiLCJiZWZvcmVBbGwiLCJjcmVhdGUiLCJtb25nb1VyaSIsImdldFVyaSIsImNvbm5lY3QiLCJmaW5kT25lQW5kVXBkYXRlIiwiaWQiLCJuYW1lIiwidHlwZSIsImNyZWF0ZWRCeSIsInVwc2VydCIsIm5ldyIsImFmdGVyQWxsIiwiZGlzY29ubmVjdCIsInN0b3AiLCJiZWZvcmVFYWNoIiwiZGVsZXRlTWFueSIsInZhbGlkVXNlckRhdGEiLCJuaWNrbmFtZSIsImVtYWlsIiwicGFzc3dvcmQiLCJpdCIsInJlc3BvbnNlIiwicG9zdCIsInNlbmQiLCJleHBlY3QiLCJib2R5IiwidG9IYXZlUHJvcGVydHkiLCJ1c2VyIiwidG9CZSIsInNhdmUiLCJlcnJvciIsInRvQ29udGFpbiIsInNob3J0Tmlja25hbWUiLCJ1c2VyRGF0YSIsImlkZW50aWZpZXIiLCJhdXRoVG9rZW4iLCJsb2dpblJlc3BvbnNlIiwidG9rZW4iLCJnZXQiLCJzZXQiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJ0b0JlR3JlYXRlclRoYW5PckVxdWFsIiwiaGFzR2VuZXJhbCIsInNvbWUiLCJjaCIsImhhc1Rlc3RDaGFubmVsIiwicG9zaXRpb24iLCJwb3MwQ2hhbm5lbCIsImZpbmQiLCJ0ZXN0Iiwib3B0aW9ucyIsImhlYWRlcnMiLCJ0b0JlRGVmaW5lZCIsInJlcXVlc3RzIiwiaSIsInB1c2giLCJyZXNwb25zZXMiLCJQcm9taXNlIiwiYWxsIiwicmF0ZUxpbWl0ZWQiLCJyZXNwIiwic3RhdHVzIl0sInNvdXJjZXMiOlsiY29udHJvbGxlci50ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdzdXBlcnRlc3QnKTtcbmNvbnN0IG1vbmdvb3NlID0gcmVxdWlyZSgnbW9uZ29vc2UnKTtcbmNvbnN0IHsgTW9uZ29NZW1vcnlTZXJ2ZXIgfSA9IHJlcXVpcmUoJ21vbmdvZGItbWVtb3J5LXNlcnZlcicpO1xuY29uc3QgYXBwID0gcmVxdWlyZSgnLi4vLi4vc2VydmVyJyk7XG5jb25zdCBVc2VyID0gcmVxdWlyZSgnLi4vLi4vbW9kZWxzL1VzZXInKTtcbmNvbnN0IENoYW5uZWwgPSByZXF1aXJlKCcuLi8uLi9tb2RlbHMvQ2hhbm5lbCcpO1xuXG5sZXQgbW9uZ29TZXJ2ZXI7XG5cbmRlc2NyaWJlKCdBUEkgQ29udHJvbGxlcnMgSW50ZWdyYXRpb24gVGVzdHMnLCAoKSA9PiB7XG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgLy8gU3RhcnQgaW4tbWVtb3J5IE1vbmdvREJcbiAgICBtb25nb1NlcnZlciA9IGF3YWl0IE1vbmdvTWVtb3J5U2VydmVyLmNyZWF0ZSgpO1xuICAgIGNvbnN0IG1vbmdvVXJpID0gbW9uZ29TZXJ2ZXIuZ2V0VXJpKCk7XG4gICAgYXdhaXQgbW9uZ29vc2UuY29ubmVjdChtb25nb1VyaSk7XG5cbiAgICAvLyBDcmVhdGUgZGVmYXVsdCBjaGFubmVsc1xuICAgIGF3YWl0IENoYW5uZWwuZmluZE9uZUFuZFVwZGF0ZShcbiAgICAgIHsgaWQ6ICdnZW5lcmFsJyB9LFxuICAgICAgeyBpZDogJ2dlbmVyYWwnLCBuYW1lOiAnR2VuZXJhbCcsIHR5cGU6ICd0ZXh0JywgY3JlYXRlZEJ5OiAnc3lzdGVtJyB9LFxuICAgICAgeyB1cHNlcnQ6IHRydWUsIG5ldzogdHJ1ZSB9XG4gICAgKTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IG1vbmdvb3NlLmRpc2Nvbm5lY3QoKTtcbiAgICBhd2FpdCBtb25nb1NlcnZlci5zdG9wKCk7XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIENsZWFyIHVzZXJzIGJ1dCBrZWVwIGNoYW5uZWxzXG4gICAgYXdhaXQgVXNlci5kZWxldGVNYW55KHt9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BPU1QgL2FwaS9yZWdpc3RlcicsICgpID0+IHtcbiAgICBjb25zdCB2YWxpZFVzZXJEYXRhID0ge1xuICAgICAgbmlja25hbWU6ICd0ZXN0dXNlcicsXG4gICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZDEyMydcbiAgICB9O1xuXG4gICAgaXQoJ3Nob3VsZCByZWdpc3RlciBhIG5ldyB1c2VyIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL3JlZ2lzdGVyJylcbiAgICAgICAgLnNlbmQodmFsaWRVc2VyRGF0YSlcbiAgICAgICAgLmV4cGVjdCgyMDEpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9IYXZlUHJvcGVydHkoJ3Rva2VuJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9IYXZlUHJvcGVydHkoJ3VzZXInKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnVzZXIubmlja25hbWUpLnRvQmUoJ3Rlc3R1c2VyJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS51c2VyLmVtYWlsKS50b0JlKCd0ZXN0QGV4YW1wbGUuY29tJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDkgZm9yIGR1cGxpY2F0ZSBuaWNrbmFtZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSBleGlzdGluZyB1c2VyXG4gICAgICBhd2FpdCBuZXcgVXNlcih2YWxpZFVzZXJEYXRhKS5zYXZlKCk7XG5cbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5wb3N0KCcvYXBpL3JlZ2lzdGVyJylcbiAgICAgICAgLnNlbmQodmFsaWRVc2VyRGF0YSlcbiAgICAgICAgLmV4cGVjdCg0MDkpO1xuXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5lcnJvcikudG9Db250YWluKCdhbHJlYWR5Jyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIG5pY2tuYW1lIGxlbmd0aCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHNob3J0Tmlja25hbWUgPSB7IC4uLnZhbGlkVXNlckRhdGEsIG5pY2tuYW1lOiAnYWInIH07XG5cbiAgICAgIGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS9yZWdpc3RlcicpXG4gICAgICAgIC5zZW5kKHNob3J0Tmlja25hbWUpXG4gICAgICAgIC5leHBlY3QoNDAwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BPU1QgL2FwaS9sb2dpbicsICgpID0+IHtcbiAgICBjb25zdCB1c2VyRGF0YSA9IHtcbiAgICAgIG5pY2tuYW1lOiAnbG9naW51c2VyJyxcbiAgICAgIGVtYWlsOiAnbG9naW5AZXhhbXBsZS5jb20nLFxuICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZDEyMydcbiAgICB9O1xuXG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBuZXcgVXNlcih1c2VyRGF0YSkuc2F2ZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsb2dpbiB3aXRoIGNvcnJlY3QgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgICAucG9zdCgnL2FwaS9sb2dpbicpXG4gICAgICAgIC5zZW5kKHtcbiAgICAgICAgICBpZGVudGlmaWVyOiAnbG9naW51c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJ1xuICAgICAgICB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0hhdmVQcm9wZXJ0eSgndG9rZW4nKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5KS50b0hhdmVQcm9wZXJ0eSgndXNlcicpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkudXNlci5uaWNrbmFtZSkudG9CZSgnbG9naW51c2VyJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxvZ2luIGJ5IGVtYWlsJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgaWRlbnRpZmllcjogJ2xvZ2luQGV4YW1wbGUuY29tJyxcbiAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJ1xuICAgICAgICB9KVxuICAgICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LnVzZXIuZW1haWwpLnRvQmUoJ2xvZ2luQGV4YW1wbGUuY29tJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDAgZm9yIGludmFsaWQgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgaWRlbnRpZmllcjogJ2xvZ2ludXNlcicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICd3cm9uZ3Bhc3N3b3JkJ1xuICAgICAgICB9KVxuICAgICAgICAuZXhwZWN0KDQwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdHRVQgL2FwaS9jaGFubmVscycsICgpID0+IHtcbiAgICBsZXQgYXV0aFRva2VuO1xuXG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgdXNlciBmb3IgYXV0aGVudGljYXRpb25cbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBuZXcgVXNlcih7XG4gICAgICAgIG5pY2tuYW1lOiAnY2hhbm5lbHVzZXInLFxuICAgICAgICBlbWFpbDogJ2NoYW5uZWxAZXhhbXBsZS5jb20nLFxuICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJ1xuICAgICAgfSkuc2F2ZSgpO1xuXG4gICAgICAvLyBMb2dpbiB0byBnZXQgdG9rZW5cbiAgICAgIGNvbnN0IGxvZ2luUmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLnBvc3QoJy9hcGkvbG9naW4nKVxuICAgICAgICAuc2VuZCh7XG4gICAgICAgICAgaWRlbnRpZmllcjogJ2NoYW5uZWx1c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJ1xuICAgICAgICB9KTtcblxuICAgICAgYXV0aFRva2VuID0gbG9naW5SZXNwb25zZS5ib2R5LnRva2VuO1xuXG4gICAgICAvLyBDcmVhdGUgYWRkaXRpb25hbCB0ZXN0IGNoYW5uZWxcbiAgICAgIGF3YWl0IG5ldyBDaGFubmVsKHtcbiAgICAgICAgaWQ6ICd0ZXN0Y2hhbm5lbCcsXG4gICAgICAgIG5hbWU6ICdUZXN0IENoYW5uZWwnLFxuICAgICAgICB0eXBlOiAndGV4dCcsXG4gICAgICAgIGNyZWF0ZWRCeTogJ2NoYW5uZWx1c2VyJ1xuICAgICAgfSkuc2F2ZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY2hhbm5lbHMgbGlzdCBmb3IgYXV0aGVudGljYXRlZCB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9jaGFubmVscycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YXV0aFRva2VufWApXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgZXhwZWN0KEFycmF5LmlzQXJyYXkocmVzcG9uc2UuYm9keSkpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMik7IC8vIEF0IGxlYXN0IGdlbmVyYWwgKyB0ZXN0Y2hhbm5lbFxuXG4gICAgICBjb25zdCBoYXNHZW5lcmFsID0gcmVzcG9uc2UuYm9keS5zb21lKGNoID0+IGNoLmlkID09PSAnZ2VuZXJhbCcpO1xuICAgICAgY29uc3QgaGFzVGVzdENoYW5uZWwgPSByZXNwb25zZS5ib2R5LnNvbWUoY2ggPT4gY2guaWQgPT09ICd0ZXN0Y2hhbm5lbCcpO1xuXG4gICAgICBleHBlY3QoaGFzR2VuZXJhbCkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChoYXNUZXN0Q2hhbm5lbCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwMSB3aXRob3V0IGF1dGhlbnRpY2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAgIC5nZXQoJy9hcGkvY2hhbm5lbHMnKVxuICAgICAgICAuZXhwZWN0KDQwMSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBjaGFubmVscyBzb3J0ZWQgYnkgcG9zaXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgY2hhbm5lbCB3aXRoIHBvc2l0aW9uIDBcbiAgICAgIGF3YWl0IG5ldyBDaGFubmVsKHtcbiAgICAgICAgaWQ6ICdwb3MwJyxcbiAgICAgICAgbmFtZTogJ1Bvc2l0aW9uIDAnLFxuICAgICAgICB0eXBlOiAndGV4dCcsXG4gICAgICAgIGNyZWF0ZWRCeTogJ2NoYW5uZWx1c2VyJyxcbiAgICAgICAgcG9zaXRpb246IDBcbiAgICAgIH0pLnNhdmUoKTtcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcbiAgICAgICAgLmdldCgnL2FwaS9jaGFubmVscycpXG4gICAgICAgIC5zZXQoJ0F1dGhvcml6YXRpb24nLCBgQmVhcmVyICR7YXV0aFRva2VufWApXG4gICAgICAgIC5leHBlY3QoMjAwKTtcblxuICAgICAgLy8gRmluZCB0aGUgcG9zMCBjaGFubmVsXG4gICAgICBjb25zdCBwb3MwQ2hhbm5lbCA9IHJlc3BvbnNlLmJvZHkuZmluZChjaCA9PiBjaC5pZCA9PT0gJ3BvczAnKTtcbiAgICAgIGV4cGVjdChwb3MwQ2hhbm5lbC5wb3NpdGlvbikudG9CZSgwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ1NlcnZlciBDb25maWd1cmF0aW9uICYgTWlkZGxld2FyZScsICgpID0+IHtcbiAgdGVzdCgnc2hvdWxkIGhhdmUgQ09SUyBlbmFibGVkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXG4gICAgICAub3B0aW9ucygnL2FwaS9oZWFsdGgnKVxuICAgICAgLnNldCgnT3JpZ2luJywgJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCcpXG4gICAgICAuZXhwZWN0KDIwNCk7XG5cbiAgICBleHBlY3QocmVzcG9uc2UuaGVhZGVyc1snYWNjZXNzLWNvbnRyb2wtYWxsb3ctb3JpZ2luJ10pLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBoYXZlIHJhdGUgbGltaXRpbmcgY29uZmlndXJlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXF1ZXN0cyA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjsgaSsrKSB7XG4gICAgICByZXF1ZXN0cy5wdXNoKFxuICAgICAgICByZXF1ZXN0KGFwcClcbiAgICAgICAgICAucG9zdCgnL2FwaS9sb2dpbicpXG4gICAgICAgICAgLnNlbmQoeyBpZGVudGlmaWVyOiAndGVzdCcsIHBhc3N3b3JkOiAndGVzdCcgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocmVxdWVzdHMpO1xuXG4gICAgLy8gU29tZSBzaG91bGQgYmUgcmF0ZSBsaW1pdGVkICg0MjkpXG4gICAgY29uc3QgcmF0ZUxpbWl0ZWQgPSByZXNwb25zZXMuc29tZShyZXNwID0+IHJlc3Auc3RhdHVzID09PSA0MjkpO1xuICAgIGV4cGVjdChyYXRlTGltaXRlZCkudG9CZSh0cnVlKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHNlcnZlIGhlYWx0aCBjaGVjayBlbmRwb2ludCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxuICAgICAgLmdldCgnL2hlYWx0aCcpXG4gICAgICAuZXhwZWN0KDIwMCk7XG5cbiAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9IYXZlUHJvcGVydHkoJ3N0YXR1cycsICdoZWFsdGh5Jyk7XG4gICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvSGF2ZVByb3BlcnR5KCd1cHRpbWUnKTtcbiAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9IYXZlUHJvcGVydHkoJ3RpbWVzdGFtcCcpO1xuICB9KTtcbn0pOyJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsV0FBVyxDQUFDO0FBQ3BDLE1BQU1DLFFBQVEsR0FBR0QsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUNwQyxNQUFNO0VBQUVFO0FBQWtCLENBQUMsR0FBR0YsT0FBTyxDQUFDLHVCQUF1QixDQUFDO0FBQzlELE1BQU1HLEdBQUcsR0FBR0gsT0FBTyxDQUFDLGNBQWMsQ0FBQztBQUNuQyxNQUFNSSxJQUFJLEdBQUdKLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztBQUN6QyxNQUFNSyxPQUFPLEdBQUdMLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQztBQUUvQyxJQUFJTSxXQUFXO0FBRWZDLFFBQVEsQ0FBQyxtQ0FBbUMsRUFBRSxNQUFNO0VBQ2xEQyxTQUFTLENBQUMsWUFBWTtJQUNwQjtJQUNBRixXQUFXLEdBQUcsTUFBTUosaUJBQWlCLENBQUNPLE1BQU0sQ0FBQyxDQUFDO0lBQzlDLE1BQU1DLFFBQVEsR0FBR0osV0FBVyxDQUFDSyxNQUFNLENBQUMsQ0FBQztJQUNyQyxNQUFN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