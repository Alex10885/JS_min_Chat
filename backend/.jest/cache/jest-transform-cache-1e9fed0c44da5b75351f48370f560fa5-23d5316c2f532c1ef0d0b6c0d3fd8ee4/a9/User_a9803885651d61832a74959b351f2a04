b515fb8d1d00f868ea6172ee0f989bb0
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
const crypto = require('crypto');
const userSchema = new mongoose.Schema({
  nickname: {
    type: String,
    required: true,
    unique: true,
    trim: true,
    minlength: 3,
    maxlength: 50,
    index: true // Remove duplicate index call below
  },
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,
    trim: true,
    index: true // Remove duplicate index call below
  },
  password: {
    type: String,
    required: true,
    minlength: 6
  },
  role: {
    type: String,
    enum: ['admin', 'member'],
    default: 'member'
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  lastActive: {
    type: Date,
    default: Date.now
  },
  status: {
    type: String,
    enum: ['online', 'offline'],
    default: 'offline'
  },
  resetPasswordToken: {
    type: String,
    default: null
  },
  resetPasswordExpires: {
    type: Date,
    default: null
  }
});

// Hash password before saving
userSchema.pre('save', async function (next) {
  if (!this.isModified('password')) return next();
  console.log('Hashing password for user:', this.nickname);
  try {
    const salt = await bcrypt.genSalt(12);
    console.log('Salt generated:', salt);
    this.password = await bcrypt.hash(this.password, salt);
    console.log('Password hashed successfully');
    next();
  } catch (error) {
    console.error('Error hashing password:', error.message);
    next(error);
  }
});

// Compare password method
userSchema.methods.comparePassword = async function (candidatePassword) {
  return bcrypt.compare(candidatePassword, this.password);
};

// Generate reset password token
userSchema.methods.generateResetToken = function () {
  // Generate random token
  const resetToken = crypto.randomBytes(32).toString('hex');

  // Hash token before storing
  this.resetPasswordToken = crypto.createHash('sha256').update(resetToken).digest('hex');

  // Set expiration (1 hour from now)
  this.resetPasswordExpires = Date.now() + 60 * 60 * 1000; // 1 hour

  return resetToken;
};

// Reset password using token
userSchema.methods.resetPassword = function (token, newPassword) {
  const hashedToken = crypto.createHash('sha256').update(token).digest('hex');
  if (hashedToken !== this.resetPasswordToken) {
    throw new Error('Invalid or expired password reset token');
  }
  if (Date.now() > this.resetPasswordExpires) {
    throw new Error('Password reset token has expired');
  }
  this.password = newPassword;
  this.resetPasswordToken = null;
  this.resetPasswordExpires = null;
  return this.save();
};

// Remove password from JSON output
userSchema.methods.toJSON = function () {
  const userObject = this.toObject();
  delete userObject.password;
  return userObject;
};
module.exports = mongoose.model('User', userSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJiY3J5cHQiLCJjcnlwdG8iLCJ1c2VyU2NoZW1hIiwiU2NoZW1hIiwibmlja25hbWUiLCJ0eXBlIiwiU3RyaW5nIiwicmVxdWlyZWQiLCJ1bmlxdWUiLCJ0cmltIiwibWlubGVuZ3RoIiwibWF4bGVuZ3RoIiwiaW5kZXgiLCJlbWFpbCIsImxvd2VyY2FzZSIsInBhc3N3b3JkIiwicm9sZSIsImVudW0iLCJkZWZhdWx0IiwiY3JlYXRlZEF0IiwiRGF0ZSIsIm5vdyIsImxhc3RBY3RpdmUiLCJzdGF0dXMiLCJyZXNldFBhc3N3b3JkVG9rZW4iLCJyZXNldFBhc3N3b3JkRXhwaXJlcyIsInByZSIsIm5leHQiLCJpc01vZGlmaWVkIiwiY29uc29sZSIsImxvZyIsInNhbHQiLCJnZW5TYWx0IiwiaGFzaCIsImVycm9yIiwibWVzc2FnZSIsIm1ldGhvZHMiLCJjb21wYXJlUGFzc3dvcmQiLCJjYW5kaWRhdGVQYXNzd29yZCIsImNvbXBhcmUiLCJnZW5lcmF0ZVJlc2V0VG9rZW4iLCJyZXNldFRva2VuIiwicmFuZG9tQnl0ZXMiLCJ0b1N0cmluZyIsImNyZWF0ZUhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJyZXNldFBhc3N3b3JkIiwidG9rZW4iLCJuZXdQYXNzd29yZCIsImhhc2hlZFRva2VuIiwiRXJyb3IiLCJzYXZlIiwidG9KU09OIiwidXNlck9iamVjdCIsInRvT2JqZWN0IiwibW9kdWxlIiwiZXhwb3J0cyIsIm1vZGVsIl0sInNvdXJjZXMiOlsiVXNlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XG5jb25zdCBiY3J5cHQgPSByZXF1aXJlKCdiY3J5cHRqcycpO1xuY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5cbmNvbnN0IHVzZXJTY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHtcbiAgbmlja25hbWU6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgdW5pcXVlOiB0cnVlLFxuICAgIHRyaW06IHRydWUsXG4gICAgbWlubGVuZ3RoOiAzLFxuICAgIG1heGxlbmd0aDogNTAsXG4gICAgaW5kZXg6IHRydWUgLy8gUmVtb3ZlIGR1cGxpY2F0ZSBpbmRleCBjYWxsIGJlbG93XG4gIH0sXG4gIGVtYWlsOiB7XG4gICAgdHlwZTogU3RyaW5nLFxuICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIHVuaXF1ZTogdHJ1ZSxcbiAgICBsb3dlcmNhc2U6IHRydWUsXG4gICAgdHJpbTogdHJ1ZSxcbiAgICBpbmRleDogdHJ1ZSAvLyBSZW1vdmUgZHVwbGljYXRlIGluZGV4IGNhbGwgYmVsb3dcbiAgfSxcbiAgcGFzc3dvcmQ6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgbWlubGVuZ3RoOiA2XG4gIH0sXG4gIHJvbGU6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgZW51bTogWydhZG1pbicsICdtZW1iZXInXSxcbiAgICBkZWZhdWx0OiAnbWVtYmVyJ1xuICB9LFxuICBjcmVhdGVkQXQ6IHtcbiAgICB0eXBlOiBEYXRlLFxuICAgIGRlZmF1bHQ6IERhdGUubm93XG4gIH0sXG4gIGxhc3RBY3RpdmU6IHtcbiAgICB0eXBlOiBEYXRlLFxuICAgIGRlZmF1bHQ6IERhdGUubm93XG4gIH0sXG4gIHN0YXR1czoge1xuICAgIHR5cGU6IFN0cmluZyxcbiAgICBlbnVtOiBbJ29ubGluZScsICdvZmZsaW5lJ10sXG4gICAgZGVmYXVsdDogJ29mZmxpbmUnXG4gIH0sXG4gIHJlc2V0UGFzc3dvcmRUb2tlbjoge1xuICAgIHR5cGU6IFN0cmluZyxcbiAgICBkZWZhdWx0OiBudWxsXG4gIH0sXG4gIHJlc2V0UGFzc3dvcmRFeHBpcmVzOiB7XG4gICAgdHlwZTogRGF0ZSxcbiAgICBkZWZhdWx0OiBudWxsXG4gIH1cbn0pO1xuXG4vLyBIYXNoIHBhc3N3b3JkIGJlZm9yZSBzYXZpbmdcbnVzZXJTY2hlbWEucHJlKCdzYXZlJywgYXN5bmMgZnVuY3Rpb24obmV4dCkge1xuICAgaWYgKCF0aGlzLmlzTW9kaWZpZWQoJ3Bhc3N3b3JkJykpIHJldHVybiBuZXh0KCk7XG5cbiAgIGNvbnNvbGUubG9nKCdIYXNoaW5nIHBhc3N3b3JkIGZvciB1c2VyOicsIHRoaXMubmlja25hbWUpO1xuICAgdHJ5IHtcbiAgICAgY29uc3Qgc2FsdCA9IGF3YWl0IGJjcnlwdC5nZW5TYWx0KDEyKTtcbiAgICAgY29uc29sZS5sb2coJ1NhbHQgZ2VuZXJhdGVkOicsIHNhbHQpO1xuICAgICB0aGlzLnBhc3N3b3JkID0gYXdhaXQgYmNyeXB0Lmhhc2godGhpcy5wYXNzd29yZCwgc2FsdCk7XG4gICAgIGNvbnNvbGUubG9nKCdQYXNzd29yZCBoYXNoZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgIG5leHQoKTtcbiAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGhhc2hpbmcgcGFzc3dvcmQ6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgIG5leHQoZXJyb3IpO1xuICAgfVxuIH0pO1xuXG4vLyBDb21wYXJlIHBhc3N3b3JkIG1ldGhvZFxudXNlclNjaGVtYS5tZXRob2RzLmNvbXBhcmVQYXNzd29yZCA9IGFzeW5jIGZ1bmN0aW9uKGNhbmRpZGF0ZVBhc3N3b3JkKSB7XG4gIHJldHVybiBiY3J5cHQuY29tcGFyZShjYW5kaWRhdGVQYXNzd29yZCwgdGhpcy5wYXNzd29yZCk7XG59O1xuXG4vLyBHZW5lcmF0ZSByZXNldCBwYXNzd29yZCB0b2tlblxudXNlclNjaGVtYS5tZXRob2RzLmdlbmVyYXRlUmVzZXRUb2tlbiA9IGZ1bmN0aW9uKCkge1xuICAvLyBHZW5lcmF0ZSByYW5kb20gdG9rZW5cbiAgY29uc3QgcmVzZXRUb2tlbiA9IGNyeXB0by5yYW5kb21CeXRlcygzMikudG9TdHJpbmcoJ2hleCcpO1xuXG4gIC8vIEhhc2ggdG9rZW4gYmVmb3JlIHN0b3JpbmdcbiAgdGhpcy5yZXNldFBhc3N3b3JkVG9rZW4gPSBjcnlwdG9cbiAgICAuY3JlYXRlSGFzaCgnc2hhMjU2JylcbiAgICAudXBkYXRlKHJlc2V0VG9rZW4pXG4gICAgLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgLy8gU2V0IGV4cGlyYXRpb24gKDEgaG91ciBmcm9tIG5vdylcbiAgdGhpcy5yZXNldFBhc3N3b3JkRXhwaXJlcyA9IERhdGUubm93KCkgKyA2MCAqIDYwICogMTAwMDsgLy8gMSBob3VyXG5cbiAgcmV0dXJuIHJlc2V0VG9rZW47XG59O1xuXG4vLyBSZXNldCBwYXNzd29yZCB1c2luZyB0b2tlblxudXNlclNjaGVtYS5tZXRob2RzLnJlc2V0UGFzc3dvcmQgPSBmdW5jdGlvbih0b2tlbiwgbmV3UGFzc3dvcmQpIHtcbiAgY29uc3QgaGFzaGVkVG9rZW4gPSBjcnlwdG9cbiAgICAuY3JlYXRlSGFzaCgnc2hhMjU2JylcbiAgICAudXBkYXRlKHRva2VuKVxuICAgIC5kaWdlc3QoJ2hleCcpO1xuXG4gIGlmIChoYXNoZWRUb2tlbiAhPT0gdGhpcy5yZXNldFBhc3N3b3JkVG9rZW4pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgb3IgZXhwaXJlZCBwYXNzd29yZCByZXNldCB0b2tlbicpO1xuICB9XG5cbiAgaWYgKERhdGUubm93KCkgPiB0aGlzLnJlc2V0UGFzc3dvcmRFeHBpcmVzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdQYXNzd29yZCByZXNldCB0b2tlbiBoYXMgZXhwaXJlZCcpO1xuICB9XG5cbiAgdGhpcy5wYXNzd29yZCA9IG5ld1Bhc3N3b3JkO1xuICB0aGlzLnJlc2V0UGFzc3dvcmRUb2tlbiA9IG51bGw7XG4gIHRoaXMucmVzZXRQYXNzd29yZEV4cGlyZXMgPSBudWxsO1xuXG4gIHJldHVybiB0aGlzLnNhdmUoKTtcbn07XG5cbi8vIFJlbW92ZSBwYXNzd29yZCBmcm9tIEpTT04gb3V0cHV0XG51c2VyU2NoZW1hLm1ldGhvZHMudG9KU09OID0gZnVuY3Rpb24oKSB7XG4gIGNvbnN0IHVzZXJPYmplY3QgPSB0aGlzLnRvT2JqZWN0KCk7XG4gIGRlbGV0ZSB1c2VyT2JqZWN0LnBhc3N3b3JkO1xuICByZXR1cm4gdXNlck9iamVjdDtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gbW9uZ29vc2UubW9kZWwoJ1VzZXInLCB1c2VyU2NoZW1hKTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLFFBQVEsR0FBR0MsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUNwQyxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDbEMsTUFBTUUsTUFBTSxHQUFHRixPQUFPLENBQUMsUUFBUSxDQUFDO0FBRWhDLE1BQU1HLFVBQVUsR0FBRyxJQUFJSixRQUFRLENBQUNLLE1BQU0sQ0FBQztFQUNyQ0MsUUFBUSxFQUFFO0lBQ1JDLElBQUksRUFBRUMsTUFBTTtJQUNaQyxRQUFRLEVBQUUsSUFBSTtJQUNkQyxNQUFNLEVBQUUsSUFBSTtJQUNaQyxJQUFJLEVBQUUsSUFBSTtJQUNWQyxTQUFTLEVBQUUsQ0FBQztJQUNaQyxTQUFTLEVBQUUsRUFBRTtJQUNiQyxLQUFLLEVBQUUsSUFBSSxDQUFDO0VBQ2QsQ0FBQztFQUNEQyxLQUFLLEVBQUU7SUFDTFIsSUFBSSxFQUFFQyxNQUFNO0lBQ1pDLFFBQVEsRUFBRSxJQUFJO0lBQ2RDLE1BQU0sRUFBRSxJQUFJO0lBQ1pNLFNBQVMsRUFBRSxJQUFJO0lBQ2ZMLElBQUksRUFBRSxJQUFJO0lBQ1ZHLEtBQUssRUFBRSxJQUFJLENBQUM7RUFDZCxDQUFDO0VBQ0RHLFFBQVEsRUFBRTtJQUNSVixJQUFJLEVBQUVDLE1BQU07SUFDWkMsUUFBUSxFQUFFLElBQUk7SUFDZEcsU0FBUyxFQUFFO0VBQ2IsQ0FBQztFQUNETSxJQUFJLEVBQUU7SUFDSlgsSUFBSSxFQUFFQyxNQUFNO0lBQ1pXLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUM7SUFDekJDLE9BQU8sRUFBRTtFQUNYLENBQUM7RUFDREMsU0FBUyxFQUFFO0lBQ1RkLElBQUksRUFBRWUsSUFBSTtJQUNWRixP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