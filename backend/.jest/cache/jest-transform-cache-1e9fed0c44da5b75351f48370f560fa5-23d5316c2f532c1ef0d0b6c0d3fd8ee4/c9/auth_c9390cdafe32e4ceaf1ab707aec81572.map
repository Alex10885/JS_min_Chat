{"version":3,"names":["jwt","require","winston","config","User","logger","createLogger","level","format","combine","timestamp","errors","stack","json","defaultMeta","service","transports","File","filename","Console","colorize","simple","authenticateSession","req","res","next","console","log","url","method","sessionId","sessionID","sessionExists","session","sessionData","authenticated","userId","nickname","role","loginTime","csrfToken","substring","sid","userAgent","user","findById","id","_id","status","sessionValid","sessionUser","lastSessionCheck","Date","toISOString","error","warn","message","ip","authenticateToken","authHeader","headers","token","split","hasAuthHeader","hasToken","code","decoded","verify","security","jwtSecret","name","requireModerator","hasModeratorPrivileges","requireAdmin","hasAdminPrivileges","module","exports"],"sources":["auth.js"],"sourcesContent":["const jwt = require('jsonwebtoken');\nconst winston = require('winston');\nconst config = require('../config');\nconst User = require('../models/User');\n\nconst logger = winston.createLogger({\n  level: config.logger.level,\n  format: winston.format.combine(\n    winston.format.timestamp(),\n    winston.format.errors({ stack: true }),\n    winston.format.json()\n  ),\n  defaultMeta: { service: 'chat-server-auth' },\n  transports: [\n    new winston.transports.File({ filename: 'logs/server.log' }),\n    new winston.transports.Console({\n      format: winston.format.combine(\n        winston.format.colorize(),\n        winston.format.simple()\n      )\n    })\n  ]\n});\n\n// Session authentication middleware (works parallel to JWT)\nconst authenticateSession = async (req, res, next) => {\n  try {\n    console.log('🔐 Session authentication middleware called:', {\n      url: req.url,\n      method: req.method,\n      sessionId: req.sessionID,\n      sessionExists: !!req.session,\n      sessionData: req.session ? {\n        authenticated: req.session.authenticated,\n        userId: req.session.userId,\n        nickname: req.session.nickname,\n        role: req.session.role,\n        loginTime: req.session.loginTime,\n        csrfToken: req.session.csrfToken?.substring(0, 8) + '...'\n      } : null\n    });\n\n    // Check if session exists and has authenticated user\n    if (req.session && req.session.authenticated && req.session.userId) {\n      console.log('🎯 Found authenticated session for userId:', req.session.userId);\n      console.log('🔓 Session fingerprint check:', {\n        sid: req.sessionID,\n        csrfToken: req.session.csrfToken?.substring(0, 4) + '...',\n        userAgent: req.session.userAgent?.substring(0, 20) + '...',\n        loginTime: req.session.loginTime\n      });\n\n      const user = await User.findById(req.session.userId);\n      if (user) {\n        console.log('✅ Session user found in DB:', {\n          nickname: user.nickname,\n          id: user._id,\n          status: user.status,\n          sessionValid: true\n        });\n        req.sessionUser = user; // Store in req.sessionUser to avoid conflict with JWT req.user\n\n        // Update session fingerprint if needed\n        if (req.session.csrfToken && req.session.userAgent) {\n          req.session.lastSessionCheck = new Date().toISOString();\n          console.log('🔐 Session fingerprint verified and updated');\n        }\n      } else {\n        console.log('⚠️ Session user not found in DB, cleaning session:', req.session.userId);\n        // Clean invalid session\n        delete req.session.authenticated;\n        delete req.session.userId;\n        delete req.session.nickname;\n        delete req.session.role;\n      }\n    } else {\n      console.log('🔍 No authenticated session found or session not initialized', {\n        sessionId: req.sessionID,\n        session: !!req.session,\n        authenticated: req.session?.authenticated,\n        userId: req.session?.userId\n      });\n      req.sessionUser = null; // Explicitly set to null when no session\n    }\n    next();\n  } catch (error) {\n    logger.warn('Session authentication error:', {\n      error: error.message,\n      sessionId: req.sessionID,\n      ip: req.ip\n    });\n    req.sessionUser = null; // Set to null on error\n    next();\n  }\n};\n\n// JWT authentication middleware\nconst authenticateToken = async (req, res, next) => {\n  try {\n    console.log('🔐 JWT authentication middleware called:', { url: req.url, method: req.method });\n    const authHeader = req.headers['authorization'];\n    const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN\n\n    console.log('🔑 Token extraction result:', { hasAuthHeader: !!authHeader, hasToken: !!token });\n\n    if (!token) {\n      console.log('❌ No token provided');\n      return res.status(401).json({\n        error: 'Access token required',\n        code: 'NO_TOKEN'\n      });\n    }\n\n    const decoded = jwt.verify(token, config.security.jwtSecret);\n    console.log('✅ JWT decoded:', { userId: decoded.userId, nickname: decoded.nickname });\n    const user = await User.findById(decoded.userId);\n\n    if (!user) {\n      console.log('❌ User not found in DB for JWT userId:', decoded.userId);\n      return res.status(401).json({\n        error: 'User not found',\n        code: 'USER_NOT_FOUND'\n      });\n    }\n\n    req.user = user;\n    console.log('✅ JWT authentication successful for user:', user.nickname, { id: user._id, status: user.status });\n    next();\n  } catch (error) {\n    logger.warn('JWT authentication failed:', {\n      error: error.message,\n      ip: req.ip\n    });\n\n    if (error.name === 'JsonWebTokenError') {\n      return res.status(401).json({\n        error: 'Invalid token format',\n        code: 'INVALID_TOKEN_FORMAT'\n      });\n    }\n\n    if (error.name === 'TokenExpiredError') {\n      return res.status(401).json({\n        error: 'Token has expired',\n        code: 'TOKEN_EXPIRED'\n      });\n    }\n\n    return res.status(401).json({\n      error: 'Token verification failed',\n      code: 'TOKEN_VERIFICATION_FAILED'\n    });\n  }\n};\n\n// Role-based access control middleware\nconst requireModerator = async (req, res, next) => {\n  try {\n    if (!req.user) {\n      return res.status(401).json({\n        error: 'Authentication required',\n        code: 'AUTH_REQUIRED'\n      });\n    }\n\n    if (!req.user.hasModeratorPrivileges()) {\n      return res.status(403).json({\n        error: 'Moderator privileges required',\n        code: 'MODERATOR_REQUIRED'\n      });\n    }\n\n    next();\n  } catch (error) {\n    logger.error('Moderator check error:', error);\n    res.status(500).json({\n      error: 'Server error during authorization check',\n      code: 'AUTH_CHECK_ERROR'\n    });\n  }\n};\n\nconst requireAdmin = async (req, res, next) => {\n  try {\n    if (!req.user) {\n      return res.status(401).json({\n        error: 'Authentication required',\n        code: 'AUTH_REQUIRED'\n      });\n    }\n\n    if (!req.user.hasAdminPrivileges()) {\n      return res.status(403).json({\n        error: 'Administrator privileges required',\n        code: 'ADMIN_REQUIRED'\n      });\n    }\n\n    next();\n  } catch (error) {\n    logger.error('Admin check error:', error);\n    res.status(500).json({\n      error: 'Server error during authorization check',\n      code: 'AUTH_CHECK_ERROR'\n    });\n  }\n};\n\nmodule.exports = {\n  authenticateSession,\n  authenticateToken,\n  requireModerator,\n  requireAdmin,\n  logger\n};"],"mappings":"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","ignoreList":[]}