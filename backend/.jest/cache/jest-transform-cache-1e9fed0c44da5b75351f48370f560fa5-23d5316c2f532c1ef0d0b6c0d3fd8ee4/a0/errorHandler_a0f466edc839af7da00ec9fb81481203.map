{"version":3,"names":["cov_2cgi2bufws","actualCoverage","winston","s","require","config","logger","createLogger","level","format","combine","timestamp","errors","stack","json","defaultMeta","service","transports","File","filename","Console","colorize","simple","errorHandler","err","req","res","_next","f","error","message","url","method","ip","userAgent","get","name","b","Object","values","map","e","field","path","value","status","details","code","keys","keyValue","requestId","id","requestLogger","next","start","Date","now","on","duration","info","statusCode","user","nickname","sessionUser","body","JSON","stringify","undefined","debugLogger","headers","notFoundHandler","console","warn","module","exports"],"sources":["errorHandler.js"],"sourcesContent":["const winston = require('winston');\nconst config = require('../config');\n\nconst logger = winston.createLogger({\n  level: config.logger.level,\n  format: winston.format.combine(\n    winston.format.timestamp(),\n    winston.format.errors({ stack: true }),\n    winston.format.json()\n  ),\n  defaultMeta: { service: 'chat-server-error-handler' },\n  transports: [\n    new winston.transports.File({ filename: 'logs/server.log' }),\n    new winston.transports.Console({\n      format: winston.format.combine(\n        winston.format.colorize(),\n        winston.format.simple()\n      )\n    })\n  ]\n});\n\n// Error handling middleware\nconst errorHandler = (err, req, res, _next) => {\n  logger.error('Unhandled error:', {\n    message: err.message,\n    stack: err.stack,\n    url: req.url,\n    method: req.method,\n    ip: req.ip,\n    userAgent: req.get('User-Agent')\n  });\n\n  // Mongoose validation errors\n  if (err.name === 'ValidationError') {\n    const errors = Object.values(err.errors).map(e => ({\n      field: e.path,\n      message: e.message,\n      value: e.value\n    }));\n\n    return res.status(422).json({\n      error: 'Validation failed',\n      details: errors,\n      code: 'VALIDATION_ERROR'\n    });\n  }\n\n  // Mongoose duplicate key error\n  if (err.code === 11000) {\n    const field = Object.keys(err.keyValue)[0];\n    const value = err.keyValue[field];\n    return res.status(409).json({\n      error: `${field} '${value}' already exists`,\n      code: 'DUPLICATE_ERROR'\n    });\n  }\n\n  // JWT errors\n  if (err.name === 'JsonWebTokenError') {\n    return res.status(401).json({\n      error: 'Invalid or expired token',\n      code: 'INVALID_TOKEN'\n    });\n  }\n\n  if (err.name === 'TokenExpiredError') {\n    return res.status(401).json({\n      error: 'Token has expired',\n      code: 'TOKEN_EXPIRED'\n    });\n  }\n\n  // Default server error\n  res.status(500).json({\n    error: 'Internal server error',\n    code: 'INTERNAL_ERROR',\n    requestId: req.id || 'unknown'\n  });\n};\n\n// Request logging middleware\nconst requestLogger = (req, res, next) => {\n  const start = Date.now();\n\n  res.on('finish', () => {\n    const duration = Date.now() - start;\n    logger.info(`${req.method} ${req.url} - ${res.statusCode} (${duration}ms)`, {\n      ip: req.ip,\n      userAgent: req.get('User-Agent'),\n      user: req.user?.nickname || req.sessionUser?.nickname || 'anonymous',\n      body: req.method !== 'GET' ? JSON.stringify(req.body) : undefined\n    });\n  });\n\n  next();\n};\n\n// Log middleware to check incoming requests\nconst debugLogger = (req, res, next) => {\n  logger.info(`üîç Incoming request: ${req.method} ${req.url}`, {\n    ip: req.ip,\n    userAgent: req.get('User-Agent'),\n    headers: req.headers\n  });\n  next();\n};\n\n// 404 handler\nconst notFoundHandler = (req, res) => {\n  console.warn('‚ùå Final 404 handler executed - route not found!', { method: req.method, url: req.url });\n  logger.warn(`404 - ${req.method} ${req.url}`, {\n    ip: req.ip,\n    userAgent: req.get('User-Agent')\n  });\n\n  res.status(404).json({\n    error: 'Endpoint not found',\n    path: req.url,\n    method: req.method,\n    code: 'NOT_FOUND'\n  });\n};\n\nmodule.exports = {\n  errorHandler,\n  requestLogger,\n  debugLogger,\n  notFoundHandler,\n  logger\n};"],"mappings":"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","ignoreList":[]}