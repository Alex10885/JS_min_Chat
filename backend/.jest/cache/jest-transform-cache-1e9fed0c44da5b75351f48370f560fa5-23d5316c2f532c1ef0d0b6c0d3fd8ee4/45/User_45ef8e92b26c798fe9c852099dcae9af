fbbb8c5ae2f3d553b94ab6843d95d7b9
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
const crypto = require('crypto');
const userSchema = new mongoose.Schema({
  nickname: {
    type: String,
    required: true,
    unique: true,
    trim: true,
    minlength: 3,
    maxlength: 50
  },
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,
    trim: true
  },
  password: {
    type: String,
    required: true,
    minlength: 6
  },
  role: {
    type: String,
    enum: ['admin', 'member'],
    default: 'member'
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  lastActive: {
    type: Date,
    default: Date.now
  },
  status: {
    type: String,
    enum: ['online', 'offline'],
    default: 'offline'
  },
  resetPasswordToken: {
    type: String,
    default: null
  },
  resetPasswordExpires: {
    type: Date,
    default: null
  }
});

// Index for performance
userSchema.index({
  nickname: 1
});
userSchema.index({
  email: 1
});

// Hash password before saving
userSchema.pre('save', async function (next) {
  if (!this.isModified('password')) return next();
  console.log('Hashing password for user:', this.nickname);
  try {
    const salt = await bcrypt.genSalt(12);
    console.log('Salt generated:', salt);
    this.password = await bcrypt.hash(this.password, salt);
    console.log('Password hashed successfully');
    next();
  } catch (error) {
    console.error('Error hashing password:', error.message);
    next(error);
  }
});

// Compare password method
userSchema.methods.comparePassword = async function (candidatePassword) {
  return bcrypt.compare(candidatePassword, this.password);
};

// Generate reset password token
userSchema.methods.generateResetToken = function () {
  // Generate random token
  const resetToken = crypto.randomBytes(32).toString('hex');

  // Hash token before storing
  this.resetPasswordToken = crypto.createHash('sha256').update(resetToken).digest('hex');

  // Set expiration (1 hour from now)
  this.resetPasswordExpires = Date.now() + 60 * 60 * 1000; // 1 hour

  return resetToken;
};

// Reset password using token
userSchema.methods.resetPassword = function (token, newPassword) {
  const hashedToken = crypto.createHash('sha256').update(token).digest('hex');
  if (hashedToken !== this.resetPasswordToken) {
    throw new Error('Invalid or expired password reset token');
  }
  if (Date.now() > this.resetPasswordExpires) {
    throw new Error('Password reset token has expired');
  }
  this.password = newPassword;
  this.resetPasswordToken = null;
  this.resetPasswordExpires = null;
  return this.save();
};

// Remove password from JSON output
userSchema.methods.toJSON = function () {
  const userObject = this.toObject();
  delete userObject.password;
  return userObject;
};
module.exports = mongoose.model('User', userSchema);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJiY3J5cHQiLCJjcnlwdG8iLCJ1c2VyU2NoZW1hIiwiU2NoZW1hIiwibmlja25hbWUiLCJ0eXBlIiwiU3RyaW5nIiwicmVxdWlyZWQiLCJ1bmlxdWUiLCJ0cmltIiwibWlubGVuZ3RoIiwibWF4bGVuZ3RoIiwiZW1haWwiLCJsb3dlcmNhc2UiLCJwYXNzd29yZCIsInJvbGUiLCJlbnVtIiwiZGVmYXVsdCIsImNyZWF0ZWRBdCIsIkRhdGUiLCJub3ciLCJsYXN0QWN0aXZlIiwic3RhdHVzIiwicmVzZXRQYXNzd29yZFRva2VuIiwicmVzZXRQYXNzd29yZEV4cGlyZXMiLCJpbmRleCIsInByZSIsIm5leHQiLCJpc01vZGlmaWVkIiwiY29uc29sZSIsImxvZyIsInNhbHQiLCJnZW5TYWx0IiwiaGFzaCIsImVycm9yIiwibWVzc2FnZSIsIm1ldGhvZHMiLCJjb21wYXJlUGFzc3dvcmQiLCJjYW5kaWRhdGVQYXNzd29yZCIsImNvbXBhcmUiLCJnZW5lcmF0ZVJlc2V0VG9rZW4iLCJyZXNldFRva2VuIiwicmFuZG9tQnl0ZXMiLCJ0b1N0cmluZyIsImNyZWF0ZUhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJyZXNldFBhc3N3b3JkIiwidG9rZW4iLCJuZXdQYXNzd29yZCIsImhhc2hlZFRva2VuIiwiRXJyb3IiLCJzYXZlIiwidG9KU09OIiwidXNlck9iamVjdCIsInRvT2JqZWN0IiwibW9kdWxlIiwiZXhwb3J0cyIsIm1vZGVsIl0sInNvdXJjZXMiOlsiVXNlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XG5jb25zdCBiY3J5cHQgPSByZXF1aXJlKCdiY3J5cHRqcycpO1xuY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5cbmNvbnN0IHVzZXJTY2hlbWEgPSBuZXcgbW9uZ29vc2UuU2NoZW1hKHtcbiAgbmlja25hbWU6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgdW5pcXVlOiB0cnVlLFxuICAgIHRyaW06IHRydWUsXG4gICAgbWlubGVuZ3RoOiAzLFxuICAgIG1heGxlbmd0aDogNTBcbiAgfSxcbiAgZW1haWw6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgdW5pcXVlOiB0cnVlLFxuICAgIGxvd2VyY2FzZTogdHJ1ZSxcbiAgICB0cmltOiB0cnVlXG4gIH0sXG4gIHBhc3N3b3JkOiB7XG4gICAgdHlwZTogU3RyaW5nLFxuICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIG1pbmxlbmd0aDogNlxuICB9LFxuICByb2xlOiB7XG4gICAgdHlwZTogU3RyaW5nLFxuICAgIGVudW06IFsnYWRtaW4nLCAnbWVtYmVyJ10sXG4gICAgZGVmYXVsdDogJ21lbWJlcidcbiAgfSxcbiAgY3JlYXRlZEF0OiB7XG4gICAgdHlwZTogRGF0ZSxcbiAgICBkZWZhdWx0OiBEYXRlLm5vd1xuICB9LFxuICBsYXN0QWN0aXZlOiB7XG4gICAgdHlwZTogRGF0ZSxcbiAgICBkZWZhdWx0OiBEYXRlLm5vd1xuICB9LFxuICBzdGF0dXM6IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgZW51bTogWydvbmxpbmUnLCAnb2ZmbGluZSddLFxuICAgIGRlZmF1bHQ6ICdvZmZsaW5lJ1xuICB9LFxuICByZXNldFBhc3N3b3JkVG9rZW46IHtcbiAgICB0eXBlOiBTdHJpbmcsXG4gICAgZGVmYXVsdDogbnVsbFxuICB9LFxuICByZXNldFBhc3N3b3JkRXhwaXJlczoge1xuICAgIHR5cGU6IERhdGUsXG4gICAgZGVmYXVsdDogbnVsbFxuICB9XG59KTtcblxuLy8gSW5kZXggZm9yIHBlcmZvcm1hbmNlXG51c2VyU2NoZW1hLmluZGV4KHsgbmlja25hbWU6IDEgfSk7XG51c2VyU2NoZW1hLmluZGV4KHsgZW1haWw6IDEgfSk7XG5cbi8vIEhhc2ggcGFzc3dvcmQgYmVmb3JlIHNhdmluZ1xudXNlclNjaGVtYS5wcmUoJ3NhdmUnLCBhc3luYyBmdW5jdGlvbihuZXh0KSB7XG4gICBpZiAoIXRoaXMuaXNNb2RpZmllZCgncGFzc3dvcmQnKSkgcmV0dXJuIG5leHQoKTtcblxuICAgY29uc29sZS5sb2coJ0hhc2hpbmcgcGFzc3dvcmQgZm9yIHVzZXI6JywgdGhpcy5uaWNrbmFtZSk7XG4gICB0cnkge1xuICAgICBjb25zdCBzYWx0ID0gYXdhaXQgYmNyeXB0LmdlblNhbHQoMTIpO1xuICAgICBjb25zb2xlLmxvZygnU2FsdCBnZW5lcmF0ZWQ6Jywgc2FsdCk7XG4gICAgIHRoaXMucGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaCh0aGlzLnBhc3N3b3JkLCBzYWx0KTtcbiAgICAgY29uc29sZS5sb2coJ1Bhc3N3b3JkIGhhc2hlZCBzdWNjZXNzZnVsbHknKTtcbiAgICAgbmV4dCgpO1xuICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgY29uc29sZS5lcnJvcignRXJyb3IgaGFzaGluZyBwYXNzd29yZDonLCBlcnJvci5tZXNzYWdlKTtcbiAgICAgbmV4dChlcnJvcik7XG4gICB9XG4gfSk7XG5cbi8vIENvbXBhcmUgcGFzc3dvcmQgbWV0aG9kXG51c2VyU2NoZW1hLm1ldGhvZHMuY29tcGFyZVBhc3N3b3JkID0gYXN5bmMgZnVuY3Rpb24oY2FuZGlkYXRlUGFzc3dvcmQpIHtcbiAgcmV0dXJuIGJjcnlwdC5jb21wYXJlKGNhbmRpZGF0ZVBhc3N3b3JkLCB0aGlzLnBhc3N3b3JkKTtcbn07XG5cbi8vIEdlbmVyYXRlIHJlc2V0IHBhc3N3b3JkIHRva2VuXG51c2VyU2NoZW1hLm1ldGhvZHMuZ2VuZXJhdGVSZXNldFRva2VuID0gZnVuY3Rpb24oKSB7XG4gIC8vIEdlbmVyYXRlIHJhbmRvbSB0b2tlblxuICBjb25zdCByZXNldFRva2VuID0gY3J5cHRvLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jyk7XG5cbiAgLy8gSGFzaCB0b2tlbiBiZWZvcmUgc3RvcmluZ1xuICB0aGlzLnJlc2V0UGFzc3dvcmRUb2tlbiA9IGNyeXB0b1xuICAgIC5jcmVhdGVIYXNoKCdzaGEyNTYnKVxuICAgIC51cGRhdGUocmVzZXRUb2tlbilcbiAgICAuZGlnZXN0KCdoZXgnKTtcblxuICAvLyBTZXQgZXhwaXJhdGlvbiAoMSBob3VyIGZyb20gbm93KVxuICB0aGlzLnJlc2V0UGFzc3dvcmRFeHBpcmVzID0gRGF0ZS5ub3coKSArIDYwICogNjAgKiAxMDAwOyAvLyAxIGhvdXJcblxuICByZXR1cm4gcmVzZXRUb2tlbjtcbn07XG5cbi8vIFJlc2V0IHBhc3N3b3JkIHVzaW5nIHRva2VuXG51c2VyU2NoZW1hLm1ldGhvZHMucmVzZXRQYXNzd29yZCA9IGZ1bmN0aW9uKHRva2VuLCBuZXdQYXNzd29yZCkge1xuICBjb25zdCBoYXNoZWRUb2tlbiA9IGNyeXB0b1xuICAgIC5jcmVhdGVIYXNoKCdzaGEyNTYnKVxuICAgIC51cGRhdGUodG9rZW4pXG4gICAgLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgaWYgKGhhc2hlZFRva2VuICE9PSB0aGlzLnJlc2V0UGFzc3dvcmRUb2tlbikge1xuICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBvciBleHBpcmVkIHBhc3N3b3JkIHJlc2V0IHRva2VuJyk7XG4gIH1cblxuICBpZiAoRGF0ZS5ub3coKSA+IHRoaXMucmVzZXRQYXNzd29yZEV4cGlyZXMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Bhc3N3b3JkIHJlc2V0IHRva2VuIGhhcyBleHBpcmVkJyk7XG4gIH1cblxuICB0aGlzLnBhc3N3b3JkID0gbmV3UGFzc3dvcmQ7XG4gIHRoaXMucmVzZXRQYXNzd29yZFRva2VuID0gbnVsbDtcbiAgdGhpcy5yZXNldFBhc3N3b3JkRXhwaXJlcyA9IG51bGw7XG5cbiAgcmV0dXJuIHRoaXMuc2F2ZSgpO1xufTtcblxuLy8gUmVtb3ZlIHBhc3N3b3JkIGZyb20gSlNPTiBvdXRwdXRcbnVzZXJTY2hlbWEubWV0aG9kcy50b0pTT04gPSBmdW5jdGlvbigpIHtcbiAgY29uc3QgdXNlck9iamVjdCA9IHRoaXMudG9PYmplY3QoKTtcbiAgZGVsZXRlIHVzZXJPYmplY3QucGFzc3dvcmQ7XG4gIHJldHVybiB1c2VyT2JqZWN0O1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBtb25nb29zZS5tb2RlbCgnVXNlcicsIHVzZXJTY2hlbWEpOyJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsUUFBUSxHQUFHQyxPQUFPLENBQUMsVUFBVSxDQUFDO0FBQ3BDLE1BQU1DLE1BQU0sR0FBR0QsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUNsQyxNQUFNRSxNQUFNLEdBQUdGLE9BQU8sQ0FBQyxRQUFRLENBQUM7QUFFaEMsTUFBTUcsVUFBVSxHQUFHLElBQUlKLFFBQVEsQ0FBQ0ssTUFBTSxDQUFDO0VBQ3JDQyxRQUFRLEVBQUU7SUFDUkMsSUFBSSxFQUFFQyxNQUFNO0lBQ1pDLFFBQVEsRUFBRSxJQUFJO0lBQ2RDLE1BQU0sRUFBRSxJQUFJO0lBQ1pDLElBQUksRUFBRSxJQUFJO0lBQ1ZDLFNBQVMsRUFBRSxDQUFDO0lBQ1pDLFNBQVMsRUFBRTtFQUNiLENBQUM7RUFDREMsS0FBSyxFQUFFO0lBQ0xQLElBQUksRUFBRUMsTUFBTTtJQUNaQyxRQUFRLEVBQUUsSUFBSTtJQUNkQyxNQUFNLEVBQUUsSUFBSTtJQUNaSyxTQUFTLEVBQUUsSUFBSTtJQUNmSixJQUFJLEVBQUU7RUFDUixDQUFDO0VBQ0RLLFFBQVEsRUFBRTtJQUNSVCxJQUFJLEVBQUVDLE1BQU07SUFDWkMsUUFBUSxFQUFFLElBQUk7SUFDZEcsU0FBUyxFQUFFO0VBQ2IsQ0FBQztFQUNESyxJQUFJLEVBQUU7SUFDSlYsSUFBSSxFQUFFQyxNQUFNO0lBQ1pVLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUM7SUFDekJDLE9BQU8sRUFBRTtFQUNYLENBQUM7RUFDREMsU0FBUyxFQUFFO0lBQ1RiLElBQUksRUFBRWMsSUFBSTtJQUNWRixPQUFPLEVBQUVFLElBQUksQ0FBQ0M7RUFDaEIsQ0FBQztFQUNEQyxVQUFVLEVBQUU7SUFDVmhCLElBQUksRUFBRWMsSUFBSTtJQUNW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