85f846870d36ada96096a43f5d77567a
const winston = require('winston');

// Circuit breaker states
const CIRCUIT_STATES = {
  CLOSED: 'closed',
  OPEN: 'open',
  HALF_OPEN: 'half-open'
};

// Circuit breaker class for protecting external services
class CircuitBreaker {
  constructor(options = {}) {
    this.failureThreshold = options.failureThreshold || 5;
    this.timeout = options.timeout || 10000;
    this.monitorInterval = options.monitorInterval || 60000; // 1 minute
    this.successThreshold = options.successThreshold || 2;
    this.state = CIRCUIT_STATES.CLOSED;
    this.failureCount = 0;
    this.successCount = 0;
    this.nextAttempt = 0;
    this.callTimeout = null;

    // Logger setup
    this.logger = winston.createLogger({
      level: 'info',
      format: winston.format.combine(winston.format.timestamp(), winston.format.errors({
        stack: true
      }), winston.format.json()),
      transports: [new winston.transports.File({
        filename: 'logs/circuit-breaker.log'
      }), new winston.transports.Console({
        format: winston.format.combine(winston.format.colorize(), winston.format.simple())
      })]
    });
    this.startMonitoring();
  }

  // Execute function with circuit breaker protection
  async execute(operation, fallback = null) {
    if (this.isOpen()) {
      if (fallback) {
        return await fallback();
      }
      throw new Error('Circuit breaker is OPEN');
    }
    if (this.isHalfOpen()) {
      return await this.attemptRecovery(operation);
    }
    return await this.safeExecute(operation);
  }

  // Check if circuit is open (rejecting requests)
  isOpen() {
    return this.state === CIRCUIT_STATES.OPEN;
  }

  // Check if circuit is half-open (testing recovery)
  isHalfOpen() {
    return this.state === CIRCUIT_STATES.HALF_OPEN;
  }

  // Check if circuit is closed (normal operation)
  isClosed() {
    return this.state === CIRCUIT_STATES.CLOSED;
  }

  // Safe execute with failure tracking
  async safeExecute(operation) {
    try {
      this.callTimeout = setTimeout(() => {
        this.recordFailure();
        throw new Error('Circuit breaker timeout');
      }, this.timeout);
      const result = await operation();
      clearTimeout(this.callTimeout);
      this.recordSuccess();
      return result;
    } catch (error) {
      clearTimeout(this.callTimeout);
      this.recordFailure();
      throw error;
    }
  }

  // Attempt recovery when circuit is half-open
  async attemptRecovery(operation) {
    try {
      const result = await this.safeExecute(operation);
      this.successCount++;
      if (this.successCount >= this.successThreshold) {
        this.reset();
      }
      return result;
    } catch (error) {
      this.recordFailure(error);
      throw error;
    }
  }

  // Record successful operation
  recordSuccess() {
    this.failureCount = 0;
    this.successCount = 0;
    this.state = CIRCUIT_STATES.CLOSED;
  }

  // Record failed operation
  recordFailure(error = null) {
    this.failureCount++;
    this.successCount = 0;
    if (this.failureCount >= this.failureThreshold) {
      this.trip();
    }
    if (error) {
      this.logger.warn('Circuit breaker failure recorded', {
        failureCount: this.failureCount,
        threshold: this.failureThreshold,
        error: error.message,
        timestamp: new Date().toISOString()
      });
    }
  }

  // Trip circuit to open state
  trip() {
    this.state = CIRCUIT_STATES.OPEN;
    this.nextAttempt = Date.now() + this.timeout;
    this.logger.warn('Circuit breaker tripped to OPEN state', {
      failureCount: this.failureCount,
      nextAttempt: new Date(this.nextAttempt).toISOString(),
      timestamp: new Date().toISOString()
    });
  }

  // Reset circuit breaker
  reset() {
    this.state = CIRCUIT_STATES.CLOSED;
    this.failureCount = 0;
    this.successCount = 0;
    this.logger.info('Circuit breaker reset to CLOSED state', {
      timestamp: new Date().toISOString()
    });
  }

  // Force attempt recovery (move to half-open)
  attempt() {
    if (this.isOpen() && Date.now() >= this.nextAttempt) {
      this.state = CIRCUIT_STATES.HALF_OPEN;
      this.successCount = 0;
      this.logger.info('Circuit breaker attempting recovery (HALF-OPEN)', {
        timestamp: new Date().toISOString()
      });
    }
  }

  // Start monitoring circuit state
  startMonitoring() {
    setInterval(() => {
      if (this.isOpen() && Date.now() >= this.nextAttempt) {
        this.attempt();
      }

      // Log current state
      this.logger.debug('Circuit breaker status', {
        state: this.state,
        failureCount: this.failureCount,
        successCount: this.successCount,
        timestamp: new Date().toISOString()
      });
    }, this.monitorInterval);
  }

  // Get current status
  getStatus() {
    return {
      state: this.state,
      failureCount: this.failureCount,
      successCount: this.successCount,
      failureThreshold: this.failureThreshold,
      successThreshold: this.successThreshold,
      timeout: this.timeout,
      nextAttempt: this.isOpen() ? new Date(this.nextAttempt).toISOString() : null
    };
  }
}

// Service-specific circuit breakers
class ExternalServiceBreaker {
  constructor() {
    // Circuit breaker for email service
    this.emailBreaker = new CircuitBreaker({
      failureThreshold: 3,
      timeout: 30000,
      monitorInterval: 30000,
      successThreshold: 2
    });

    // Circuit breaker for Redis
    this.redisBreaker = new CircuitBreaker({
      failureThreshold: 5,
      timeout: 5000,
      monitorInterval: 15000,
      successThreshold: 3
    });

    // Circuit breaker for database operations
    this.databaseBreaker = new CircuitBreaker({
      failureThreshold: 5,
      timeout: 15000,
      monitorInterval: 20000,
      successThreshold: 3
    });
  }

  // Email service protection
  async executeWithEmailBreaker(operation) {
    return await this.emailBreaker.execute(operation, async () => {
      // Fallback: queue email for later retry
      winston.log('warn', 'Email service is unavailable, queuing for retry');
      return {
        status: 'queued',
        message: 'Email service unavailable'
      };
    });
  }

  // Redis protection
  async executeWithRedisBreaker(operation) {
    return await this.redisBreaker.execute(operation, async () => {
      // Fallback: skip caching
      winston.log('warn', 'Redis is unavailable, skipping cache operation');
      return null;
    });
  }

  // Database protection
  async executeWithDatabaseBreaker(operation) {
    return await this.databaseBreaker.execute(operation, async () => {
      // Fallback: throw error
      throw new Error('Database is unavailable due to circuit breaker protection');
    });
  }

  // Get status of all circuit breakers
  getAllStatuses() {
    return {
      emailService: this.emailBreaker.getStatus(),
      redis: this.redisBreaker.getStatus(),
      database: this.databaseBreaker.getStatus()
    };
  }
}

// Singleton instance
const externalServiceBreaker = new ExternalServiceBreaker();

// Middleware for protecting API endpoints with circuit breaker
const circuitBreakerMiddleware = (breakerType = 'database') => {
  return async (req, res, next) => {
    try {
      // Add circuit breaker status to request
      req.circuitBreakerStatus = {};

      // Execute request normally
      next();
    } catch (error) {
      winston.log('error', 'Circuit breaker middleware error', {
        error: error.message,
        breakerType,
        endpoint: req.url,
        method: req.method
      });
      next(error);
    }
  };
};

// Async optimization wrapper
const asyncOptimize = (fn, options = {}) => {
  const concurrency = options.concurrency || 5;
  const timeout = options.timeout || 30000;
  let running = 0;
  const queue = [];
  return async function (...args) {
    return new Promise((resolve, reject) => {
      const execute = async () => {
        if (running >= concurrency) {
          queue.push({
            args,
            resolve,
            reject
          });
          return;
        }
        running++;
        const startTime = Date.now();
        try {
          // Set timeout for operation
          const timeoutPromise = new Promise((_, timeoutReject) => {
            setTimeout(() => timeoutReject(new Error('Operation timeout')), timeout);
          });
          const result = await Promise.race([fn.apply(this, args), timeoutPromise]);
          const executionTime = Date.now() - startTime;

          // Log slow operations
          if (executionTime > (options.slowThreshold || 5000)) {
            winston.log('warn', 'Slow async operation', {
              executionTime,
              functionName: fn.name,
              timestamp: new Date().toISOString()
            });
          }
          resolve(result);
        } catch (error) {
          reject(error);
        } finally {
          running--;

          // Process next item in queue
          if (queue.length > 0) {
            const next = queue.shift();
            setImmediate(execute.bind(this, next.args, next.resolve, next.reject));
          }
        }
      };
      if (running < concurrency) {
        execute.apply(this, args);
      } else {
        queue.push({
          args,
          resolve,
          reject
        });
      }
    });
  };
};
module.exports = {
  CircuitBreaker,
  ExternalServiceBreaker,
  externalServiceBreaker,
  circuitBreakerMiddleware,
  asyncOptimize,
  // Convenience exports
  protectEmail: fn => externalServiceBreaker.executeWithEmailBreaker(fn),
  protectRedis: fn => externalServiceBreaker.executeWithRedisBreaker(fn),
  protectDatabase: fn => externalServiceBreaker.executeWithDatabaseBreaker(fn),
  getCircuitBreakerStatuses: () => externalServiceBreaker.getAllStatuses()
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ3aW5zdG9uIiwicmVxdWlyZSIsIkNJUkNVSVRfU1RBVEVTIiwiQ0xPU0VEIiwiT1BFTiIsIkhBTEZfT1BFTiIsIkNpcmN1aXRCcmVha2VyIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiZmFpbHVyZVRocmVzaG9sZCIsInRpbWVvdXQiLCJtb25pdG9ySW50ZXJ2YWwiLCJzdWNjZXNzVGhyZXNob2xkIiwic3RhdGUiLCJmYWlsdXJlQ291bnQiLCJzdWNjZXNzQ291bnQiLCJuZXh0QXR0ZW1wdCIsImNhbGxUaW1lb3V0IiwibG9nZ2VyIiwiY3JlYXRlTG9nZ2VyIiwibGV2ZWwiLCJmb3JtYXQiLCJjb21iaW5lIiwidGltZXN0YW1wIiwiZXJyb3JzIiwic3RhY2siLCJqc29uIiwidHJhbnNwb3J0cyIsIkZpbGUiLCJmaWxlbmFtZSIsIkNvbnNvbGUiLCJjb2xvcml6ZSIsInNpbXBsZSIsInN0YXJ0TW9uaXRvcmluZyIsImV4ZWN1dGUiLCJvcGVyYXRpb24iLCJmYWxsYmFjayIsImlzT3BlbiIsIkVycm9yIiwiaXNIYWxmT3BlbiIsImF0dGVtcHRSZWNvdmVyeSIsInNhZmVFeGVjdXRlIiwiaXNDbG9zZWQiLCJzZXRUaW1lb3V0IiwicmVjb3JkRmFpbHVyZSIsInJlc3VsdCIsImNsZWFyVGltZW91dCIsInJlY29yZFN1Y2Nlc3MiLCJlcnJvciIsInJlc2V0IiwidHJpcCIsIndhcm4iLCJ0aHJlc2hvbGQiLCJtZXNzYWdlIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwibm93IiwiaW5mbyIsImF0dGVtcHQiLCJzZXRJbnRlcnZhbCIsImRlYnVnIiwiZ2V0U3RhdHVzIiwiRXh0ZXJuYWxTZXJ2aWNlQnJlYWtlciIsImVtYWlsQnJlYWtlciIsInJlZGlzQnJlYWtlciIsImRhdGFiYXNlQnJlYWtlciIsImV4ZWN1dGVXaXRoRW1haWxCcmVha2VyIiwibG9nIiwic3RhdHVzIiwiZXhlY3V0ZVdpdGhSZWRpc0JyZWFrZXIiLCJleGVjdXRlV2l0aERhdGFiYXNlQnJlYWtlciIsImdldEFsbFN0YXR1c2VzIiwiZW1haWxTZXJ2aWNlIiwicmVkaXMiLCJkYXRhYmFzZSIsImV4dGVybmFsU2VydmljZUJyZWFrZXIiLCJjaXJjdWl0QnJlYWtlck1pZGRsZXdhcmUiLCJicmVha2VyVHlwZSIsInJlcSIsInJlcyIsIm5leHQiLCJjaXJjdWl0QnJlYWtlclN0YXR1cyIsImVuZHBvaW50IiwidXJsIiwibWV0aG9kIiwiYXN5bmNPcHRpbWl6ZSIsImZuIiwiY29uY3VycmVuY3kiLCJydW5uaW5nIiwicXVldWUiLCJhcmdzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJwdXNoIiwic3RhcnRUaW1lIiwidGltZW91dFByb21pc2UiLCJfIiwidGltZW91dFJlamVjdCIsInJhY2UiLCJhcHBseSIsImV4ZWN1dGlvblRpbWUiLCJzbG93VGhyZXNob2xkIiwiZnVuY3Rpb25OYW1lIiwibmFtZSIsImxlbmd0aCIsInNoaWZ0Iiwic2V0SW1tZWRpYXRlIiwiYmluZCIsIm1vZHVsZSIsImV4cG9ydHMiLCJwcm90ZWN0RW1haWwiLCJwcm90ZWN0UmVkaXMiLCJwcm90ZWN0RGF0YWJhc2UiLCJnZXRDaXJjdWl0QnJlYWtlclN0YXR1c2VzIl0sInNvdXJjZXMiOlsiY2lyY3VpdEJyZWFrZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUoJ3dpbnN0b24nKTtcblxuLy8gQ2lyY3VpdCBicmVha2VyIHN0YXRlc1xuY29uc3QgQ0lSQ1VJVF9TVEFURVMgPSB7XG4gIENMT1NFRDogJ2Nsb3NlZCcsXG4gIE9QRU46ICdvcGVuJyxcbiAgSEFMRl9PUEVOOiAnaGFsZi1vcGVuJ1xufTtcblxuLy8gQ2lyY3VpdCBicmVha2VyIGNsYXNzIGZvciBwcm90ZWN0aW5nIGV4dGVybmFsIHNlcnZpY2VzXG5jbGFzcyBDaXJjdWl0QnJlYWtlciB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuZmFpbHVyZVRocmVzaG9sZCA9IG9wdGlvbnMuZmFpbHVyZVRocmVzaG9sZCB8fCA1O1xuICAgIHRoaXMudGltZW91dCA9IG9wdGlvbnMudGltZW91dCB8fCAxMDAwMDtcbiAgICB0aGlzLm1vbml0b3JJbnRlcnZhbCA9IG9wdGlvbnMubW9uaXRvckludGVydmFsIHx8IDYwMDAwOyAvLyAxIG1pbnV0ZVxuICAgIHRoaXMuc3VjY2Vzc1RocmVzaG9sZCA9IG9wdGlvbnMuc3VjY2Vzc1RocmVzaG9sZCB8fCAyO1xuXG4gICAgdGhpcy5zdGF0ZSA9IENJUkNVSVRfU1RBVEVTLkNMT1NFRDtcbiAgICB0aGlzLmZhaWx1cmVDb3VudCA9IDA7XG4gICAgdGhpcy5zdWNjZXNzQ291bnQgPSAwO1xuICAgIHRoaXMubmV4dEF0dGVtcHQgPSAwO1xuXG4gICAgdGhpcy5jYWxsVGltZW91dCA9IG51bGw7XG5cbiAgICAvLyBMb2dnZXIgc2V0dXBcbiAgICB0aGlzLmxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcbiAgICAgIGxldmVsOiAnaW5mbycsXG4gICAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgIHdpbnN0b24uZm9ybWF0LnRpbWVzdGFtcCgpLFxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5lcnJvcnMoeyBzdGFjazogdHJ1ZSB9KSxcbiAgICAgICAgd2luc3Rvbi5mb3JtYXQuanNvbigpXG4gICAgICApLFxuICAgICAgdHJhbnNwb3J0czogW1xuICAgICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkZpbGUoeyBmaWxlbmFtZTogJ2xvZ3MvY2lyY3VpdC1icmVha2VyLmxvZycgfSksXG4gICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7XG4gICAgICAgICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICAgICAgd2luc3Rvbi5mb3JtYXQuY29sb3JpemUoKSxcbiAgICAgICAgICAgIHdpbnN0b24uZm9ybWF0LnNpbXBsZSgpXG4gICAgICAgICAgKVxuICAgICAgICB9KVxuICAgICAgXVxuICAgIH0pO1xuXG4gICAgdGhpcy5zdGFydE1vbml0b3JpbmcoKTtcbiAgfVxuXG4gIC8vIEV4ZWN1dGUgZnVuY3Rpb24gd2l0aCBjaXJjdWl0IGJyZWFrZXIgcHJvdGVjdGlvblxuICBhc3luYyBleGVjdXRlKG9wZXJhdGlvbiwgZmFsbGJhY2sgPSBudWxsKSB7XG4gICAgaWYgKHRoaXMuaXNPcGVuKCkpIHtcbiAgICAgIGlmIChmYWxsYmFjaykge1xuICAgICAgICByZXR1cm4gYXdhaXQgZmFsbGJhY2soKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2lyY3VpdCBicmVha2VyIGlzIE9QRU4nKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0hhbGZPcGVuKCkpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmF0dGVtcHRSZWNvdmVyeShvcGVyYXRpb24pO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnNhZmVFeGVjdXRlKG9wZXJhdGlvbik7XG4gIH1cblxuICAvLyBDaGVjayBpZiBjaXJjdWl0IGlzIG9wZW4gKHJlamVjdGluZyByZXF1ZXN0cylcbiAgaXNPcGVuKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlID09PSBDSVJDVUlUX1NUQVRFUy5PUEVOO1xuICB9XG5cbiAgLy8gQ2hlY2sgaWYgY2lyY3VpdCBpcyBoYWxmLW9wZW4gKHRlc3RpbmcgcmVjb3ZlcnkpXG4gIGlzSGFsZk9wZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUgPT09IENJUkNVSVRfU1RBVEVTLkhBTEZfT1BFTjtcbiAgfVxuXG4gIC8vIENoZWNrIGlmIGNpcmN1aXQgaXMgY2xvc2VkIChub3JtYWwgb3BlcmF0aW9uKVxuICBpc0Nsb3NlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSA9PT0gQ0lSQ1VJVF9TVEFURVMuQ0xPU0VEO1xuICB9XG5cbiAgLy8gU2FmZSBleGVjdXRlIHdpdGggZmFpbHVyZSB0cmFja2luZ1xuICBhc3luYyBzYWZlRXhlY3V0ZShvcGVyYXRpb24pIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5jYWxsVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnJlY29yZEZhaWx1cmUoKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaXJjdWl0IGJyZWFrZXIgdGltZW91dCcpO1xuICAgICAgfSwgdGhpcy50aW1lb3V0KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgb3BlcmF0aW9uKCk7XG5cbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLmNhbGxUaW1lb3V0KTtcbiAgICAgIHRoaXMucmVjb3JkU3VjY2VzcygpO1xuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5jYWxsVGltZW91dCk7XG4gICAgICB0aGlzLnJlY29yZEZhaWx1cmUoKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8vIEF0dGVtcHQgcmVjb3Zlcnkgd2hlbiBjaXJjdWl0IGlzIGhhbGYtb3BlblxuICBhc3luYyBhdHRlbXB0UmVjb3Zlcnkob3BlcmF0aW9uKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuc2FmZUV4ZWN1dGUob3BlcmF0aW9uKTtcbiAgICAgIHRoaXMuc3VjY2Vzc0NvdW50Kys7XG5cbiAgICAgIGlmICh0aGlzLnN1Y2Nlc3NDb3VudCA+PSB0aGlzLnN1Y2Nlc3NUaHJlc2hvbGQpIHtcbiAgICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLnJlY29yZEZhaWx1cmUoZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLy8gUmVjb3JkIHN1Y2Nlc3NmdWwgb3BlcmF0aW9uXG4gIHJlY29yZFN1Y2Nlc3MoKSB7XG4gICAgdGhpcy5mYWlsdXJlQ291bnQgPSAwO1xuICAgIHRoaXMuc3VjY2Vzc0NvdW50ID0gMDtcbiAgICB0aGlzLnN0YXRlID0gQ0lSQ1VJVF9TVEFURVMuQ0xPU0VEO1xuICB9XG5cbiAgLy8gUmVjb3JkIGZhaWxlZCBvcGVyYXRpb25cbiAgcmVjb3JkRmFpbHVyZShlcnJvciA9IG51bGwpIHtcbiAgICB0aGlzLmZhaWx1cmVDb3VudCsrO1xuICAgIHRoaXMuc3VjY2Vzc0NvdW50ID0gMDtcblxuICAgIGlmICh0aGlzLmZhaWx1cmVDb3VudCA+PSB0aGlzLmZhaWx1cmVUaHJlc2hvbGQpIHtcbiAgICAgIHRoaXMudHJpcCgpO1xuICAgIH1cblxuICAgIGlmIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIud2FybignQ2lyY3VpdCBicmVha2VyIGZhaWx1cmUgcmVjb3JkZWQnLCB7XG4gICAgICAgIGZhaWx1cmVDb3VudDogdGhpcy5mYWlsdXJlQ291bnQsXG4gICAgICAgIHRocmVzaG9sZDogdGhpcy5mYWlsdXJlVGhyZXNob2xkLFxuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vIFRyaXAgY2lyY3VpdCB0byBvcGVuIHN0YXRlXG4gIHRyaXAoKSB7XG4gICAgdGhpcy5zdGF0ZSA9IENJUkNVSVRfU1RBVEVTLk9QRU47XG4gICAgdGhpcy5uZXh0QXR0ZW1wdCA9IERhdGUubm93KCkgKyB0aGlzLnRpbWVvdXQ7XG5cbiAgICB0aGlzLmxvZ2dlci53YXJuKCdDaXJjdWl0IGJyZWFrZXIgdHJpcHBlZCB0byBPUEVOIHN0YXRlJywge1xuICAgICAgZmFpbHVyZUNvdW50OiB0aGlzLmZhaWx1cmVDb3VudCxcbiAgICAgIG5leHRBdHRlbXB0OiBuZXcgRGF0ZSh0aGlzLm5leHRBdHRlbXB0KS50b0lTT1N0cmluZygpLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFJlc2V0IGNpcmN1aXQgYnJlYWtlclxuICByZXNldCgpIHtcbiAgICB0aGlzLnN0YXRlID0gQ0lSQ1VJVF9TVEFURVMuQ0xPU0VEO1xuICAgIHRoaXMuZmFpbHVyZUNvdW50ID0gMDtcbiAgICB0aGlzLnN1Y2Nlc3NDb3VudCA9IDA7XG5cbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdDaXJjdWl0IGJyZWFrZXIgcmVzZXQgdG8gQ0xPU0VEIHN0YXRlJywge1xuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEZvcmNlIGF0dGVtcHQgcmVjb3ZlcnkgKG1vdmUgdG8gaGFsZi1vcGVuKVxuICBhdHRlbXB0KCkge1xuICAgIGlmICh0aGlzLmlzT3BlbigpICYmIERhdGUubm93KCkgPj0gdGhpcy5uZXh0QXR0ZW1wdCkge1xuICAgICAgdGhpcy5zdGF0ZSA9IENJUkNVSVRfU1RBVEVTLkhBTEZfT1BFTjtcbiAgICAgIHRoaXMuc3VjY2Vzc0NvdW50ID0gMDtcblxuICAgICAgdGhpcy5sb2dnZXIuaW5mbygnQ2lyY3VpdCBicmVha2VyIGF0dGVtcHRpbmcgcmVjb3ZlcnkgKEhBTEYtT1BFTiknLCB7XG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvLyBTdGFydCBtb25pdG9yaW5nIGNpcmN1aXQgc3RhdGVcbiAgc3RhcnRNb25pdG9yaW5nKCkge1xuICAgIHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIGlmICh0aGlzLmlzT3BlbigpICYmIERhdGUubm93KCkgPj0gdGhpcy5uZXh0QXR0ZW1wdCkge1xuICAgICAgICB0aGlzLmF0dGVtcHQoKTtcbiAgICAgIH1cblxuICAgICAgLy8gTG9nIGN1cnJlbnQgc3RhdGVcbiAgICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdDaXJjdWl0IGJyZWFrZXIgc3RhdHVzJywge1xuICAgICAgICBzdGF0ZTogdGhpcy5zdGF0ZSxcbiAgICAgICAgZmFpbHVyZUNvdW50OiB0aGlzLmZhaWx1cmVDb3VudCxcbiAgICAgICAgc3VjY2Vzc0NvdW50OiB0aGlzLnN1Y2Nlc3NDb3VudCxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH0pO1xuICAgIH0sIHRoaXMubW9uaXRvckludGVydmFsKTtcbiAgfVxuXG4gIC8vIEdldCBjdXJyZW50IHN0YXR1c1xuICBnZXRTdGF0dXMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXRlOiB0aGlzLnN0YXRlLFxuICAgICAgZmFpbHVyZUNvdW50OiB0aGlzLmZhaWx1cmVDb3VudCxcbiAgICAgIHN1Y2Nlc3NDb3VudDogdGhpcy5zdWNjZXNzQ291bnQsXG4gICAgICBmYWlsdXJlVGhyZXNob2xkOiB0aGlzLmZhaWx1cmVUaHJlc2hvbGQsXG4gICAgICBzdWNjZXNzVGhyZXNob2xkOiB0aGlzLnN1Y2Nlc3NUaHJlc2hvbGQsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgICBuZXh0QXR0ZW1wdDogdGhpcy5pc09wZW4oKSA/IG5ldyBEYXRlKHRoaXMubmV4dEF0dGVtcHQpLnRvSVNPU3RyaW5nKCkgOiBudWxsXG4gICAgfTtcbiAgfVxufVxuXG4vLyBTZXJ2aWNlLXNwZWNpZmljIGNpcmN1aXQgYnJlYWtlcnNcbmNsYXNzIEV4dGVybmFsU2VydmljZUJyZWFrZXIge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICAvLyBDaXJjdWl0IGJyZWFrZXIgZm9yIGVtYWlsIHNlcnZpY2VcbiAgICB0aGlzLmVtYWlsQnJlYWtlciA9IG5ldyBDaXJjdWl0QnJlYWtlcih7XG4gICAgICBmYWlsdXJlVGhyZXNob2xkOiAzLFxuICAgICAgdGltZW91dDogMzAwMDAsXG4gICAgICBtb25pdG9ySW50ZXJ2YWw6IDMwMDAwLFxuICAgICAgc3VjY2Vzc1RocmVzaG9sZDogMlxuICAgIH0pO1xuXG4gICAgLy8gQ2lyY3VpdCBicmVha2VyIGZvciBSZWRpc1xuICAgIHRoaXMucmVkaXNCcmVha2VyID0gbmV3IENpcmN1aXRCcmVha2VyKHtcbiAgICAgIGZhaWx1cmVUaHJlc2hvbGQ6IDUsXG4gICAgICB0aW1lb3V0OiA1MDAwLFxuICAgICAgbW9uaXRvckludGVydmFsOiAxNTAwMCxcbiAgICAgIHN1Y2Nlc3NUaHJlc2hvbGQ6IDNcbiAgICB9KTtcblxuICAgIC8vIENpcmN1aXQgYnJlYWtlciBmb3IgZGF0YWJhc2Ugb3BlcmF0aW9uc1xuICAgIHRoaXMuZGF0YWJhc2VCcmVha2VyID0gbmV3IENpcmN1aXRCcmVha2VyKHtcbiAgICAgIGZhaWx1cmVUaHJlc2hvbGQ6IDUsXG4gICAgICB0aW1lb3V0OiAxNTAwMCxcbiAgICAgIG1vbml0b3JJbnRlcnZhbDogMjAwMDAsXG4gICAgICBzdWNjZXNzVGhyZXNob2xkOiAzXG4gICAgfSk7XG4gIH1cblxuICAvLyBFbWFpbCBzZXJ2aWNlIHByb3RlY3Rpb25cbiAgYXN5bmMgZXhlY3V0ZVdpdGhFbWFpbEJyZWFrZXIob3BlcmF0aW9uKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZW1haWxCcmVha2VyLmV4ZWN1dGUoXG4gICAgICBvcGVyYXRpb24sXG4gICAgICBhc3luYyAoKSA9PiB7XG4gICAgICAgIC8vIEZhbGxiYWNrOiBxdWV1ZSBlbWFpbCBmb3IgbGF0ZXIgcmV0cnlcbiAgICAgICAgd2luc3Rvbi5sb2coJ3dhcm4nLCAnRW1haWwgc2VydmljZSBpcyB1bmF2YWlsYWJsZSwgcXVldWluZyBmb3IgcmV0cnknKTtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzOiAncXVldWVkJywgbWVzc2FnZTogJ0VtYWlsIHNlcnZpY2UgdW5hdmFpbGFibGUnIH07XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8vIFJlZGlzIHByb3RlY3Rpb25cbiAgYXN5bmMgZXhlY3V0ZVdpdGhSZWRpc0JyZWFrZXIob3BlcmF0aW9uKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucmVkaXNCcmVha2VyLmV4ZWN1dGUoXG4gICAgICBvcGVyYXRpb24sXG4gICAgICBhc3luYyAoKSA9PiB7XG4gICAgICAgIC8vIEZhbGxiYWNrOiBza2lwIGNhY2hpbmdcbiAgICAgICAgd2luc3Rvbi5sb2coJ3dhcm4nLCAnUmVkaXMgaXMgdW5hdmFpbGFibGUsIHNraXBwaW5nIGNhY2hlIG9wZXJhdGlvbicpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLy8gRGF0YWJhc2UgcHJvdGVjdGlvblxuICBhc3luYyBleGVjdXRlV2l0aERhdGFiYXNlQnJlYWtlcihvcGVyYXRpb24pIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5kYXRhYmFzZUJyZWFrZXIuZXhlY3V0ZShcbiAgICAgIG9wZXJhdGlvbixcbiAgICAgIGFzeW5jICgpID0+IHtcbiAgICAgICAgLy8gRmFsbGJhY2s6IHRocm93IGVycm9yXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YWJhc2UgaXMgdW5hdmFpbGFibGUgZHVlIHRvIGNpcmN1aXQgYnJlYWtlciBwcm90ZWN0aW9uJyk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8vIEdldCBzdGF0dXMgb2YgYWxsIGNpcmN1aXQgYnJlYWtlcnNcbiAgZ2V0QWxsU3RhdHVzZXMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGVtYWlsU2VydmljZTogdGhpcy5lbWFpbEJyZWFrZXIuZ2V0U3RhdHVzKCksXG4gICAgICByZWRpczogdGhpcy5yZWRpc0JyZWFrZXIuZ2V0U3RhdHVzKCksXG4gICAgICBkYXRhYmFzZTogdGhpcy5kYXRhYmFzZUJyZWFrZXIuZ2V0U3RhdHVzKClcbiAgICB9O1xuICB9XG59XG5cbi8vIFNpbmdsZXRvbiBpbnN0YW5jZVxuY29uc3QgZXh0ZXJuYWxTZXJ2aWNlQnJlYWtlciA9IG5ldyBFeHRlcm5hbFNlcnZpY2VCcmVha2VyKCk7XG5cbi8vIE1pZGRsZXdhcmUgZm9yIHByb3RlY3RpbmcgQVBJIGVuZHBvaW50cyB3aXRoIGNpcmN1aXQgYnJlYWtlclxuY29uc3QgY2lyY3VpdEJyZWFrZXJNaWRkbGV3YXJlID0gKGJyZWFrZXJUeXBlID0gJ2RhdGFiYXNlJykgPT4ge1xuICByZXR1cm4gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEFkZCBjaXJjdWl0IGJyZWFrZXIgc3RhdHVzIHRvIHJlcXVlc3RcbiAgICAgIHJlcS5jaXJjdWl0QnJlYWtlclN0YXR1cyA9IHt9O1xuXG4gICAgICAvLyBFeGVjdXRlIHJlcXVlc3Qgbm9ybWFsbHlcbiAgICAgIG5leHQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgd2luc3Rvbi5sb2coJ2Vycm9yJywgJ0NpcmN1aXQgYnJlYWtlciBtaWRkbGV3YXJlIGVycm9yJywge1xuICAgICAgICBlcnJvcjogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgYnJlYWtlclR5cGUsXG4gICAgICAgIGVuZHBvaW50OiByZXEudXJsLFxuICAgICAgICBtZXRob2Q6IHJlcS5tZXRob2RcbiAgICAgIH0pO1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9O1xufTtcblxuLy8gQXN5bmMgb3B0aW1pemF0aW9uIHdyYXBwZXJcbmNvbnN0IGFzeW5jT3B0aW1pemUgPSAoZm4sIG9wdGlvbnMgPSB7fSkgPT4ge1xuICBjb25zdCBjb25jdXJyZW5jeSA9IG9wdGlvbnMuY29uY3VycmVuY3kgfHwgNTtcbiAgY29uc3QgdGltZW91dCA9IG9wdGlvbnMudGltZW91dCB8fCAzMDAwMDtcblxuICBsZXQgcnVubmluZyA9IDA7XG4gIGNvbnN0IHF1ZXVlID0gW107XG5cbiAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGV4ZWN1dGUgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmIChydW5uaW5nID49IGNvbmN1cnJlbmN5KSB7XG4gICAgICAgICAgcXVldWUucHVzaCh7IGFyZ3MsIHJlc29sdmUsIHJlamVjdCB9KTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBydW5uaW5nKys7XG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBTZXQgdGltZW91dCBmb3Igb3BlcmF0aW9uXG4gICAgICAgICAgY29uc3QgdGltZW91dFByb21pc2UgPSBuZXcgUHJvbWlzZSgoXywgdGltZW91dFJlamVjdCkgPT4ge1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aW1lb3V0UmVqZWN0KG5ldyBFcnJvcignT3BlcmF0aW9uIHRpbWVvdXQnKSksIHRpbWVvdXQpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUHJvbWlzZS5yYWNlKFtmbi5hcHBseSh0aGlzLCBhcmdzKSwgdGltZW91dFByb21pc2VdKTtcbiAgICAgICAgICBjb25zdCBleGVjdXRpb25UaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcblxuICAgICAgICAgIC8vIExvZyBzbG93IG9wZXJhdGlvbnNcbiAgICAgICAgICBpZiAoZXhlY3V0aW9uVGltZSA+IChvcHRpb25zLnNsb3dUaHJlc2hvbGQgfHwgNTAwMCkpIHtcbiAgICAgICAgICAgIHdpbnN0b24ubG9nKCd3YXJuJywgJ1Nsb3cgYXN5bmMgb3BlcmF0aW9uJywge1xuICAgICAgICAgICAgICBleGVjdXRpb25UaW1lLFxuICAgICAgICAgICAgICBmdW5jdGlvbk5hbWU6IGZuLm5hbWUsXG4gICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICBydW5uaW5nLS07XG5cbiAgICAgICAgICAvLyBQcm9jZXNzIG5leHQgaXRlbSBpbiBxdWV1ZVxuICAgICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBuZXh0ID0gcXVldWUuc2hpZnQoKTtcbiAgICAgICAgICAgIHNldEltbWVkaWF0ZShleGVjdXRlLmJpbmQodGhpcywgbmV4dC5hcmdzLCBuZXh0LnJlc29sdmUsIG5leHQucmVqZWN0KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBpZiAocnVubmluZyA8IGNvbmN1cnJlbmN5KSB7XG4gICAgICAgIGV4ZWN1dGUuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBxdWV1ZS5wdXNoKHsgYXJncywgcmVzb2x2ZSwgcmVqZWN0IH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9O1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIENpcmN1aXRCcmVha2VyLFxuICBFeHRlcm5hbFNlcnZpY2VCcmVha2VyLFxuICBleHRlcm5hbFNlcnZpY2VCcmVha2VyLFxuICBjaXJjdWl0QnJlYWtlck1pZGRsZXdhcmUsXG4gIGFzeW5jT3B0aW1pemUsXG4gIC8vIENvbnZlbmllbmNlIGV4cG9ydHNcbiAgcHJvdGVjdEVtYWlsOiAoZm4pID0+IGV4dGVybmFsU2VydmljZUJyZWFrZXIuZXhlY3V0ZVdpdGhFbWFpbEJyZWFrZXIoZm4pLFxuICBwcm90ZWN0UmVkaXM6IChmbikgPT4gZXh0ZXJuYWxTZXJ2aWNlQnJlYWtlci5leGVjdXRlV2l0aFJlZGlzQnJlYWtlcihmbiksXG4gIHByb3RlY3REYXRhYmFzZTogKGZuKSA9PiBleHRlcm5hbFNlcnZpY2VCcmVha2VyLmV4ZWN1dGVXaXRoRGF0YWJhc2VCcmVha2VyKGZuKSxcbiAgZ2V0Q2lyY3VpdEJyZWFrZXJTdGF0dXNlczogKCkgPT4gZXh0ZXJuYWxTZXJ2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