be3f3b327362a2d569df030ce6071f52
const mongoose = require('mongoose');
const winston = require('winston');
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(winston.format.timestamp(), winston.format.errors({
    stack: true
  }), winston.format.json()),
  defaultMeta: {
    service: 'database'
  },
  transports: [new winston.transports.File({
    filename: 'logs/database.log'
  }), new winston.transports.Console({
    format: winston.format.combine(winston.format.colorize(), winston.format.simple())
  })]
});
const connectDB = async (retries = 5) => {
  for (let i = 1; i <= retries; i++) {
    try {
      const conn = await mongoose.connect(process.env.MONGODB_URI, {
        // Modern Mongoose doesn't need these options, but keeping for compatibility
        // useNewUrlParser: true,
        // useUnifiedTopology: true,
        // Increase timeouts for better reliability
        serverSelectionTimeoutMS: 30000,
        socketTimeoutMS: 45000,
        connectTimeoutMS: 30000
      });
      logger.info(`MongoDB Connected: ${conn.connection.host}`);

      // Handle connection events
      mongoose.connection.on('error', err => {
        logger.error('Database connection error:', err);
      });
      mongoose.connection.on('disconnected', () => {
        logger.warn('Database disconnected');
      });
      mongoose.connection.on('reconnected', () => {
        logger.info('Database reconnected');
      });

      // Handle unexpected disconnections with reconnection
      mongoose.connection.on('disconnected', () => {
        logger.warn('Database unexpectedly disconnected, attempting to reconnect...');
        setTimeout(() => {
          connectDB(1); // Single retry on disconnection
        }, 5000);
      });
      return conn;
    } catch (error) {
      logger.error(`Database connection attempt ${i}/${retries} failed:`, error);
      if (i === retries) {
        logger.error('Database connection failed after all retries:', error);
        throw error; // Let the caller handle it
      }

      // Exponential backoff for retries
      const delay = Math.min(1000 * Math.pow(2, i - 1), 30000);
      logger.info(`Retrying database connection in ${delay}ms...`);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
};
const closeDB = async () => {
  try {
    if (mongoose.connection.readyState === 1) {
      await mongoose.connection.close();
      logger.info('Database connection closed gracefully');
    } else {
      logger.info('Database connection was not open, no need to close');
    }
  } catch (error) {
    logger.error('Error closing database connection:', error);
    // Force close if graceful close fails
    try {
      mongoose.connection.close(true);
    } catch (forceError) {
      logger.error('Force close failed:', forceError);
    }
  }
};
module.exports = {
  connectDB,
  closeDB
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJ3aW5zdG9uIiwibG9nZ2VyIiwiY3JlYXRlTG9nZ2VyIiwibGV2ZWwiLCJmb3JtYXQiLCJjb21iaW5lIiwidGltZXN0YW1wIiwiZXJyb3JzIiwic3RhY2siLCJqc29uIiwiZGVmYXVsdE1ldGEiLCJzZXJ2aWNlIiwidHJhbnNwb3J0cyIsIkZpbGUiLCJmaWxlbmFtZSIsIkNvbnNvbGUiLCJjb2xvcml6ZSIsInNpbXBsZSIsImNvbm5lY3REQiIsInJldHJpZXMiLCJpIiwiY29ubiIsImNvbm5lY3QiLCJwcm9jZXNzIiwiZW52IiwiTU9OR09EQl9VUkkiLCJzZXJ2ZXJTZWxlY3Rpb25UaW1lb3V0TVMiLCJzb2NrZXRUaW1lb3V0TVMiLCJjb25uZWN0VGltZW91dE1TIiwiaW5mbyIsImNvbm5lY3Rpb24iLCJob3N0Iiwib24iLCJlcnIiLCJlcnJvciIsIndhcm4iLCJzZXRUaW1lb3V0IiwiZGVsYXkiLCJNYXRoIiwibWluIiwicG93IiwiUHJvbWlzZSIsInJlc29sdmUiLCJjbG9zZURCIiwicmVhZHlTdGF0ZSIsImNsb3NlIiwiZm9yY2VFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJjb25uZWN0aW9uLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG1vbmdvb3NlID0gcmVxdWlyZSgnbW9uZ29vc2UnKTtcbmNvbnN0IHdpbnN0b24gPSByZXF1aXJlKCd3aW5zdG9uJyk7XG5cbmNvbnN0IGxvZ2dlciA9IHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcbiAgbGV2ZWw6ICdpbmZvJyxcbiAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgIHdpbnN0b24uZm9ybWF0LnRpbWVzdGFtcCgpLFxuICAgIHdpbnN0b24uZm9ybWF0LmVycm9ycyh7IHN0YWNrOiB0cnVlIH0pLFxuICAgIHdpbnN0b24uZm9ybWF0Lmpzb24oKVxuICApLFxuICBkZWZhdWx0TWV0YTogeyBzZXJ2aWNlOiAnZGF0YWJhc2UnIH0sXG4gIHRyYW5zcG9ydHM6IFtcbiAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkZpbGUoeyBmaWxlbmFtZTogJ2xvZ3MvZGF0YWJhc2UubG9nJyB9KSxcbiAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xuICAgICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5jb2xvcml6ZSgpLFxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5zaW1wbGUoKVxuICAgICAgKVxuICAgIH0pXG4gIF1cbn0pO1xuXG5jb25zdCBjb25uZWN0REIgPSBhc3luYyAocmV0cmllcyA9IDUpID0+IHtcbiAgZm9yIChsZXQgaSA9IDE7IGkgPD0gcmV0cmllczsgaSsrKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNvbm4gPSBhd2FpdCBtb25nb29zZS5jb25uZWN0KHByb2Nlc3MuZW52Lk1PTkdPREJfVVJJLCB7XG4gICAgICAgIC8vIE1vZGVybiBNb25nb29zZSBkb2Vzbid0IG5lZWQgdGhlc2Ugb3B0aW9ucywgYnV0IGtlZXBpbmcgZm9yIGNvbXBhdGliaWxpdHlcbiAgICAgICAgLy8gdXNlTmV3VXJsUGFyc2VyOiB0cnVlLFxuICAgICAgICAvLyB1c2VVbmlmaWVkVG9wb2xvZ3k6IHRydWUsXG4gICAgICAgIC8vIEluY3JlYXNlIHRpbWVvdXRzIGZvciBiZXR0ZXIgcmVsaWFiaWxpdHlcbiAgICAgICAgc2VydmVyU2VsZWN0aW9uVGltZW91dE1TOiAzMDAwMCxcbiAgICAgICAgc29ja2V0VGltZW91dE1TOiA0NTAwMCxcbiAgICAgICAgY29ubmVjdFRpbWVvdXRNUzogMzAwMDAsXG4gICAgICB9KTtcblxuICAgICAgbG9nZ2VyLmluZm8oYE1vbmdvREIgQ29ubmVjdGVkOiAke2Nvbm4uY29ubmVjdGlvbi5ob3N0fWApO1xuXG4gICAgICAvLyBIYW5kbGUgY29ubmVjdGlvbiBldmVudHNcbiAgICAgIG1vbmdvb3NlLmNvbm5lY3Rpb24ub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0RhdGFiYXNlIGNvbm5lY3Rpb24gZXJyb3I6JywgZXJyKTtcbiAgICAgIH0pO1xuXG4gICAgICBtb25nb29zZS5jb25uZWN0aW9uLm9uKCdkaXNjb25uZWN0ZWQnLCAoKSA9PiB7XG4gICAgICAgIGxvZ2dlci53YXJuKCdEYXRhYmFzZSBkaXNjb25uZWN0ZWQnKTtcbiAgICAgIH0pO1xuXG4gICAgICBtb25nb29zZS5jb25uZWN0aW9uLm9uKCdyZWNvbm5lY3RlZCcsICgpID0+IHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ0RhdGFiYXNlIHJlY29ubmVjdGVkJyk7XG4gICAgICB9KTtcblxuICAgICAgLy8gSGFuZGxlIHVuZXhwZWN0ZWQgZGlzY29ubmVjdGlvbnMgd2l0aCByZWNvbm5lY3Rpb25cbiAgICAgIG1vbmdvb3NlLmNvbm5lY3Rpb24ub24oJ2Rpc2Nvbm5lY3RlZCcsICgpID0+IHtcbiAgICAgICAgbG9nZ2VyLndhcm4oJ0RhdGFiYXNlIHVuZXhwZWN0ZWRseSBkaXNjb25uZWN0ZWQsIGF0dGVtcHRpbmcgdG8gcmVjb25uZWN0Li4uJyk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGNvbm5lY3REQigxKTsgLy8gU2luZ2xlIHJldHJ5IG9uIGRpc2Nvbm5lY3Rpb25cbiAgICAgICAgfSwgNTAwMCk7XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIGNvbm47XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihgRGF0YWJhc2UgY29ubmVjdGlvbiBhdHRlbXB0ICR7aX0vJHtyZXRyaWVzfSBmYWlsZWQ6YCwgZXJyb3IpO1xuXG4gICAgICBpZiAoaSA9PT0gcmV0cmllcykge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0RhdGFiYXNlIGNvbm5lY3Rpb24gZmFpbGVkIGFmdGVyIGFsbCByZXRyaWVzOicsIGVycm9yKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7IC8vIExldCB0aGUgY2FsbGVyIGhhbmRsZSBpdFxuICAgICAgfVxuXG4gICAgICAvLyBFeHBvbmVudGlhbCBiYWNrb2ZmIGZvciByZXRyaWVzXG4gICAgICBjb25zdCBkZWxheSA9IE1hdGgubWluKDEwMDAgKiBNYXRoLnBvdygyLCBpIC0gMSksIDMwMDAwKTtcbiAgICAgIGxvZ2dlci5pbmZvKGBSZXRyeWluZyBkYXRhYmFzZSBjb25uZWN0aW9uIGluICR7ZGVsYXl9bXMuLi5gKTtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBkZWxheSkpO1xuICAgIH1cbiAgfVxufTtcblxuY29uc3QgY2xvc2VEQiA9IGFzeW5jICgpID0+IHtcbiAgdHJ5IHtcbiAgICBpZiAobW9uZ29vc2UuY29ubmVjdGlvbi5yZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICBhd2FpdCBtb25nb29zZS5jb25uZWN0aW9uLmNsb3NlKCk7XG4gICAgICBsb2dnZXIuaW5mbygnRGF0YWJhc2UgY29ubmVjdGlvbiBjbG9zZWQgZ3JhY2VmdWxseScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuaW5mbygnRGF0YWJhc2UgY29ubmVjdGlvbiB3YXMgbm90IG9wZW4sIG5vIG5lZWQgdG8gY2xvc2UnKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvciBjbG9zaW5nIGRhdGFiYXNlIGNvbm5lY3Rpb246JywgZXJyb3IpO1xuICAgIC8vIEZvcmNlIGNsb3NlIGlmIGdyYWNlZnVsIGNsb3NlIGZhaWxzXG4gICAgdHJ5IHtcbiAgICAgIG1vbmdvb3NlLmNvbm5lY3Rpb24uY2xvc2UodHJ1ZSk7XG4gICAgfSBjYXRjaCAoZm9yY2VFcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdGb3JjZSBjbG9zZSBmYWlsZWQ6JywgZm9yY2VFcnJvcik7XG4gICAgfVxuICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHsgY29ubmVjdERCLCBjbG9zZURC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