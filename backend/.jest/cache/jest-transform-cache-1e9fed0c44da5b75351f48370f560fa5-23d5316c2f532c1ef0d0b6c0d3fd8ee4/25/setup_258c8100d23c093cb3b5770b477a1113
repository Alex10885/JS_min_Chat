deb4b7e9b364ca25e867a89c27c91d54
const mongoose = require('mongoose');
const {
  MongoMemoryServer
} = require('mongodb-memory-server');
const {
  connectDB,
  closeDB
} = require('../db/connection');
const {
  TestFixtures
} = require('./shared/testFixtures');
let originalMongoUri;
let mongod;
beforeAll(async () => {
  // Enable garbage collection for performance optimization
  if (global.gc) {
    global.gc();
  }

  // Save original MongoDB URI
  originalMongoUri = process.env.MONGODB_URI;

  // Start in-memory MongoDB server for tests with compatible version
  mongod = await MongoMemoryServer.create({
    binary: {
      platform: 'linux-x64',
      version: '5.0.8'
    }
  });
  const mongoUri = mongod.getUri();

  // Set test environment variables
  process.env.NODE_ENV = 'test';
  process.env.MONGODB_URI = mongoUri;
  process.env.JWT_SECRET = 'your_super_secure_jwt_secret_key_here_replace_in_production';

  // Connect to in-memory test database
  await connectDB();

  // Setup reusable fixtures for faster test execution
  console.log('Setting up test fixtures...');
  await TestFixtures.setup();
});
afterAll(async () => {
  // console.log('Cleaning up test fixtures...'); // Disabled to avoid mocking issues
  await TestFixtures.cleanup();
  await closeDB();

  // Stop the in-memory MongoDB server
  if (mongod) {
    await mongod.stop();
  }

  // Restore original URI if needed
  process.env.MONGODB_URI = originalMongoUri;

  // Final garbage collection
  if (global.gc) {
    global.gc();
  }
});
afterEach(async () => {
  // Clear all collections after each test
  if (mongoose.connection.readyState === 1) {
    // Connected
    const collections = mongoose.connection.collections;
    for (const key in collections) {
      await collections[key].deleteMany({});
    }
  }
});

// Global test timeouts and stabilization
jest.setTimeout(30000); // 30 second global timeout
process.env.NODE_TEST_TIMEOUT = 25000; // Custom env for HTTP tests

// Increase socket timeout for database operations
mongoose.set('bufferCommands', false); // Disable mongoose buffering
mongoose.set('maxTimeMS', 20000); // 20 second limit for operations
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJNb25nb01lbW9yeVNlcnZlciIsImNvbm5lY3REQiIsImNsb3NlREIiLCJUZXN0Rml4dHVyZXMiLCJvcmlnaW5hbE1vbmdvVXJpIiwibW9uZ29kIiwiYmVmb3JlQWxsIiwiZ2xvYmFsIiwiZ2MiLCJwcm9jZXNzIiwiZW52IiwiTU9OR09EQl9VUkkiLCJjcmVhdGUiLCJiaW5hcnkiLCJwbGF0Zm9ybSIsInZlcnNpb24iLCJtb25nb1VyaSIsImdldFVyaSIsIk5PREVfRU5WIiwiSldUX1NFQ1JFVCIsImNvbnNvbGUiLCJsb2ciLCJzZXR1cCIsImFmdGVyQWxsIiwiY2xlYW51cCIsInN0b3AiLCJhZnRlckVhY2giLCJjb25uZWN0aW9uIiwicmVhZHlTdGF0ZSIsImNvbGxlY3Rpb25zIiwia2V5IiwiZGVsZXRlTWFueSIsImplc3QiLCJzZXRUaW1lb3V0IiwiTk9ERV9URVNUX1RJTUVPVVQiLCJzZXQiXSwic291cmNlcyI6WyJzZXR1cC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XG5jb25zdCB7IE1vbmdvTWVtb3J5U2VydmVyIH0gPSByZXF1aXJlKCdtb25nb2RiLW1lbW9yeS1zZXJ2ZXInKTtcbmNvbnN0IHsgY29ubmVjdERCLCBjbG9zZURCIH0gPSByZXF1aXJlKCcuLi9kYi9jb25uZWN0aW9uJyk7XG5jb25zdCB7IFRlc3RGaXh0dXJlcyB9ID0gcmVxdWlyZSgnLi9zaGFyZWQvdGVzdEZpeHR1cmVzJyk7XG5cbmxldCBvcmlnaW5hbE1vbmdvVXJpO1xubGV0IG1vbmdvZDtcblxuYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICAvLyBFbmFibGUgZ2FyYmFnZSBjb2xsZWN0aW9uIGZvciBwZXJmb3JtYW5jZSBvcHRpbWl6YXRpb25cbiAgICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgICBnbG9iYWwuZ2MoKTtcbiAgICB9XG5cbiAgICAvLyBTYXZlIG9yaWdpbmFsIE1vbmdvREIgVVJJXG4gICAgb3JpZ2luYWxNb25nb1VyaSA9IHByb2Nlc3MuZW52Lk1PTkdPREJfVVJJO1xuXG4gICAgLy8gU3RhcnQgaW4tbWVtb3J5IE1vbmdvREIgc2VydmVyIGZvciB0ZXN0cyB3aXRoIGNvbXBhdGlibGUgdmVyc2lvblxuICAgIG1vbmdvZCA9IGF3YWl0IE1vbmdvTWVtb3J5U2VydmVyLmNyZWF0ZSh7XG4gICAgICBiaW5hcnk6IHtcbiAgICAgICAgcGxhdGZvcm06ICdsaW51eC14NjQnLFxuICAgICAgICB2ZXJzaW9uOiAnNS4wLjgnXG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgbW9uZ29VcmkgPSBtb25nb2QuZ2V0VXJpKCk7XG5cbiAgICAvLyBTZXQgdGVzdCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICd0ZXN0JztcbiAgICBwcm9jZXNzLmVudi5NT05HT0RCX1VSSSA9IG1vbmdvVXJpO1xuICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQgPSAneW91cl9zdXBlcl9zZWN1cmVfand0X3NlY3JldF9rZXlfaGVyZV9yZXBsYWNlX2luX3Byb2R1Y3Rpb24nO1xuXG4gICAgLy8gQ29ubmVjdCB0byBpbi1tZW1vcnkgdGVzdCBkYXRhYmFzZVxuICAgIGF3YWl0IGNvbm5lY3REQigpO1xuXG4gICAgLy8gU2V0dXAgcmV1c2FibGUgZml4dHVyZXMgZm9yIGZhc3RlciB0ZXN0IGV4ZWN1dGlvblxuICAgIGNvbnNvbGUubG9nKCdTZXR0aW5nIHVwIHRlc3QgZml4dHVyZXMuLi4nKTtcbiAgICBhd2FpdCBUZXN0Rml4dHVyZXMuc2V0dXAoKTtcbn0pO1xuXG5hZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgIC8vIGNvbnNvbGUubG9nKCdDbGVhbmluZyB1cCB0ZXN0IGZpeHR1cmVzLi4uJyk7IC8vIERpc2FibGVkIHRvIGF2b2lkIG1vY2tpbmcgaXNzdWVzXG4gICAgIGF3YWl0IFRlc3RGaXh0dXJlcy5jbGVhbnVwKCk7XG4gICAgIGF3YWl0IGNsb3NlREIoKTtcblxuICAgICAvLyBTdG9wIHRoZSBpbi1tZW1vcnkgTW9uZ29EQiBzZXJ2ZXJcbiAgICAgaWYgKG1vbmdvZCkge1xuICAgICAgIGF3YWl0IG1vbmdvZC5zdG9wKCk7XG4gICAgIH1cblxuICAgICAvLyBSZXN0b3JlIG9yaWdpbmFsIFVSSSBpZiBuZWVkZWRcbiAgICAgcHJvY2Vzcy5lbnYuTU9OR09EQl9VUkkgPSBvcmlnaW5hbE1vbmdvVXJpO1xuXG4gICAgIC8vIEZpbmFsIGdhcmJhZ2UgY29sbGVjdGlvblxuICAgICBpZiAoZ2xvYmFsLmdjKSB7XG4gICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgIH1cbiB9KTtcblxuYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyBDbGVhciBhbGwgY29sbGVjdGlvbnMgYWZ0ZXIgZWFjaCB0ZXN0XG4gICAgaWYgKG1vbmdvb3NlLmNvbm5lY3Rpb24ucmVhZHlTdGF0ZSA9PT0gMSkgeyAvLyBDb25uZWN0ZWRcbiAgICAgIGNvbnN0IGNvbGxlY3Rpb25zID0gbW9uZ29vc2UuY29ubmVjdGlvbi5jb2xsZWN0aW9ucztcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGNvbGxlY3Rpb25zKSB7XG4gICAgICAgIGF3YWl0IGNvbGxlY3Rpb25zW2tleV0uZGVsZXRlTWFueSh7fSk7XG4gICAgICB9XG4gICAgfVxuIH0pO1xuXG4vLyBHbG9iYWwgdGVzdCB0aW1lb3V0cyBhbmQgc3RhYmlsaXphdGlvblxuamVzdC5zZXRUaW1lb3V0KDMwMDAwKTsgIC8vIDMwIHNlY29uZCBnbG9iYWwgdGltZW91dFxucHJvY2Vzcy5lbnYuTk9ERV9URVNUX1RJTUVPVVQgPSAyNTAwMDsgIC8vIEN1c3RvbSBlbnYgZm9yIEhUVFAgdGVzdHNcblxuLy8gSW5jcmVhc2Ugc29ja2V0IHRpbWVvdXQgZm9yIGRhdGFiYXNlIG9wZXJhdGlvbnNcbm1vbmdvb3NlLnNldCgnYnVmZmVyQ29tbWFuZHMnLCBmYWxzZSk7ICAvLyBEaXNhYmxlIG1vbmdvb3NlIGJ1ZmZlcmluZ1xubW9uZ29vc2Uuc2V0KCdtYXhUaW1lTVMnLCAyMDAwMCk7ICAgICAgLy8gMjAgc2Vjb25kIGxpbWl0IGZvciBvcGVyYXRpb25zIl0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxRQUFRLEdBQUdDLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDcEMsTUFBTTtFQUFFQztBQUFrQixDQUFDLEdBQUdELE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztBQUM5RCxNQUFNO0VBQUVFLFNBQVM7RUFBRUM7QUFBUSxDQUFDLEdBQUdILE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQztBQUMxRCxNQUFNO0VBQUVJO0FBQWEsQ0FBQyxHQUFHSixPQUFPLENBQUMsdUJBQXVCLENBQUM7QUFFekQsSUFBSUssZ0JBQWdCO0FBQ3BCLElBQUlDLE1BQU07QUFFVkMsU0FBUyxDQUFDLFlBQVk7RUFDbEI7RUFDQSxJQUFJQyxNQUFNLENBQUNDLEVBQUUsRUFBRTtJQUNiRCxNQUFNLENBQUNDLEVBQUUsQ0FBQyxDQUFDO0VBQ2I7O0VBRUE7RUFDQUosZ0JBQWdCLEdBQUdLLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDQyxXQUFXOztFQUUxQztFQUNBTixNQUFNLEdBQUcsTUFBTUwsaUJBQWlCLENBQUNZLE1BQU0sQ0FBQztJQUN0Q0MsTUFBTSxFQUFFO01BQ05DLFFBQVEsRUFBRSxXQUFXO01BQ3JCQyxPQUFPLEVBQUU7SUFDWDtFQUNGLENBQUMsQ0FBQztFQUNGLE1BQU1DLFFBQVEsR0FBR1gsTUFBTSxDQUFDWSxNQUFNLENBQUMsQ0FBQzs7RUFFaEM7RUFDQVIsT0FBTyxDQUFDQyxHQUFHLENBQUNRLFFBQVEsR0FBRyxNQUFNO0VBQzdCVCxPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsV0FBVyxHQUFHSyxRQUFRO0VBQ2xDUCxPQUFPLENBQUNDLEdBQUcsQ0FBQ1MsVUFBVSxHQUFHLDZEQUE2RDs7RUFFdEY7RUFDQSxNQUFNbEIsU0FBUyxDQUFDLENBQUM7O0VBRWpCO0VBQ0FtQixPQUFPLENBQUNDLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQztFQUMxQyxNQUFNbEIsWUFBWSxDQUFDbUIsS0FBSyxDQUFDLENBQUM7QUFDOUIsQ0FBQyxDQUFDO0FBRUZDLFFBQVEsQ0FBQyxZQUFZO0VBQ2hCO0VBQ0EsTUFBTXBCLFlBQVksQ0FBQ3FCLE9BQU8sQ0FBQyxDQUFDO0VBQzVCLE1BQU10QixPQUFPLENBQUMsQ0FBQzs7RUFFZjtFQUNBLElBQUlHLE1BQU0sRUFBRTtJQUNWLE1BQU1BLE1BQU0sQ0FBQ29CLElBQUksQ0FBQyxDQUFDO0VBQ3JCOztFQUVBO0VBQ0FoQixPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsV0FBVyxHQUFHUCxnQkFBZ0I7O0VBRTFDO0VBQ0EsSUFBSUcsTUFBTSxDQUFDQyxFQUFFLEVBQUU7SUFDYkQsTUFBTSxDQUFDQyxFQUFFLENBQUMsQ0FBQztFQUNiO0FBQ0osQ0FBQyxDQUFDO0FBRUhrQixTQUFTLENBQUMsWUFBWTtFQUNsQjtFQUNBLElBQUk1QixRQUFRLENBQUM2QixVQUFVLENBQUNDLFVBQVUsS0FBSyxDQUFDLEVBQUU7SUFBRTtJQUMxQyxNQUFNQyxXQUFXLEdBQUcvQixRQUFRLENBQUM2QixVQUFVLENBQUNFLFdBQVc7SUFDbkQsS0FBSyxNQUFNQyxHQUFHLElBQUlELFdBQVcsRUFBRTtNQUM3QixNQUFNQSxXQUFXLENBQUNDLEdBQUcsQ0FBQyxDQUFDQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdkM7RUFDRjtBQUNILENBQUMsQ0FBQzs7QUFFSDtBQUNBQyxJQUFJLENBQUNDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFFO0FBQ3pCeEIsT0FBTyxDQUFDQyxHQUFHLENBQUN3QixpQkFBaUIsR0FBRyxLQUFLLENBQUMsQ0FBRTs7QUFFeEM7QUFDQXBDLFFBQVEsQ0FBQ3FDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFFO0FBQ3hDckMsUUFBUSxDQUFDcUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFNIiwiaWdub3JlTGlzdCI6W119