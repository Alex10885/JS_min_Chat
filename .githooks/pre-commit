#!/bin/bash

# Pre-commit hook ะดะปั Chat-JS ะฟัะพะตะบัะฐ
# ะัะฟะพะปะฝัะตั ะฟัะพะฒะตัะบะธ ะบะฐัะตััะฒะฐ ะบะพะดะฐ ะธ ัะฐััะธัะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะดะพะบัะผะตะฝัะฐัะธะธ

echo "๐ Pre-commit ะฟัะพะฒะตัะบะธ..."

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ะคะปะฐะณะธ ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั ััะฐัััะฐ
FAILED_LINT=0
FAILED_SYNTAX=0
FAILED_DOCS=0

# ะะตะฟะพะทะธัะพัะธะน ะบะพะฝัะธะณััะฐัะธะธ
REPO_ROOT=$(git rev-parse --show-toplevel)

# ะคัะฝะบัะธั ะดะปั ะฒัะฒะพะดะฐ ะพัะธะฑะพะบ
error() {
    echo -e "${RED}โ $1${NC}"
}

# ะคัะฝะบัะธั ะดะปั ะฒัะฒะพะดะฐ ะฟัะตะดัะฟัะตะถะดะตะฝะธะน
warning() {
    echo -e "${YELLOW}โ๏ธ  $1${NC}"
}

# ะคัะฝะบัะธั ะดะปั ะฒัะฒะพะดะฐ ััะฟะตัะพะฒ
success() {
    echo -e "${GREEN}โ $1${NC}"
}

# 1. ะัะพะฒะตัะบะฐ Node.js ะฒะตััะธะธ
echo "๐ฆ ะัะพะฒะตัะบะฐ Node.js..."
NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 16 ]; then
    error "Node.js version $NODE_VERSION ัะปะธัะบะพะผ ััะฐัะฐั. ะขัะตะฑัะตััั 16+"
    exit 1
fi
success "Node.js version: $(node --version)"

# 2. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะตัะปะธ package-lock.json ะธะทะผะตะฝะธะปัั
if git diff --cached --name-only | grep -E "(package-lock\.json|yarn\.lock)" > /dev/null; then
    echo "๐ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."

    if [ -d "$REPO_ROOT/frontend" ]; then
        cd "$REPO_ROOT/frontend"
        npm install --silent
        if [ $? -ne 0 ]; then
            error "ะะต ัะดะฐะปะพัั ัััะฐะฝะพะฒะธัั frontend ะทะฐะฒะธัะธะผะพััะธ"
            exit 1
        fi
    fi

    if [ -d "$REPO_ROOT/backend" ]; then
        cd "$REPO_ROOT/backend"
        npm install --silent
        if [ $? -ne 0 ]; then
            error "ะะต ัะดะฐะปะพัั ัััะฐะฝะพะฒะธัั backend ะทะฐะฒะธัะธะผะพััะธ"
            exit 1
        fi
    fi

    success "ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"
fi

cd "$REPO_ROOT"

# 3. ESLint ะฟัะพะฒะตัะบะธ (quick mode)
echo "๐ ะััััะฐั ะฟัะพะฒะตัะบะฐ ESLint..."

if [ -d "$REPO_ROOT/frontend" ]; then
    cd "$REPO_ROOT/frontend"
    if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
        npx eslint --quiet src/ --max-warnings=0
        if [ $? -ne 0 ]; then
            error "ESLint ะฟัะพะฒะตัะธะป ะพัะธะฑะบะธ ะฒะพ frontend ะบะพะดะต"
            FAILED_LINT=1
        else
            success "Frontend ESLint ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั"
        fi
    fi
fi

cd "$REPO_ROOT"

if [ -d "$REPO_ROOT/backend" ]; then
    cd "$REPO_ROOT/backend"
    if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
        npx eslint --quiet . --max-warnings=0
        if [ $? -ne 0 ]; then
            error "ESLint ะฟัะพะฒะตัะธะป ะพัะธะฑะบะธ ะฒ backend ะบะพะดะต"
            FAILED_LINT=1
        else
            success "Backend ESLint ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั"
        fi
    fi
fi

# 4. ะัะพะฒะตัะบะฐ ัะธะฝัะฐะบัะธัะฐ JavaScript/Node.js
echo "๐ ะัะพะฒะตัะบะฐ ัะธะฝัะฐะบัะธัะฐ JS..."
cd "$REPO_ROOT"

# ะัะพะฒะตัะบะฐ ะธะทะผะตะฝะตะฝะฝัั JS ัะฐะนะปะพะฒ
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' | grep -v node_modules)

if [ -n "$STAGED_JS_FILES" ]; then
    echo "$STAGED_JS_FILES" | while read -r file; do
        if [ -f "$file" ]; then
            case "$file" in
                *.js|*.jsx|*.ts|*.tsx)
                    node -c "$file" 2>/dev/null
                    if [ $? -ne 0 ]; then
                        error "ะกะธะฝัะฐะบัะธัะตัะบะฐั ะพัะธะฑะบะฐ ะฒ $file"
                        FAILED_SYNTAX=1
                    fi
                    ;;
            esac
        fi
    done

    if [ $FAILED_SYNTAX -eq 0 ]; then
        success "ะัะพะฒะตัะบะฐ ัะธะฝัะฐะบัะธัะฐ ะฟัะพะนะดะตะฝะฐ"
    fi
else
    success "ะะตั ะธะทะผะตะฝะตะฝะฝัั JS ัะฐะนะปะพะฒ ะดะปั ะฟัะพะฒะตัะบะธ"
fi

# 5. ะะฑะฝะพะฒะปะตะฝะธะต ะดะพะบัะผะตะฝัะฐัะธะธ (ะฑัััััะน ัะตะถะธะผ)
echo "๐ ะััััะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะดะพะบัะผะตะฝัะพะฒ..."
cd "$REPO_ROOT"

# ะัะพะฒะตัะบะฐ ะฟัะฐะฒ ะฝะฐ ะธัะฟะพะปะฝะตะฝะธะต ัะบัะธะฟัะฐ
if [ ! -x "scripts/generate-docs.js" ]; then
    chmod +x scripts/generate-docs.js
    success "ะกะดะตะปะฐะปะธ generate-docs.js ะธัะฟะพะปะฝัะตะผัะผ"
fi

# ะััััะพะต ะพะฑะฝะพะฒะปะตะฝะธะต README ะตัะปะธ ะพะฝ ะธะทะผะตะฝะธะปัั
if git diff --cached --name-only | grep -E "(README\.md|CHANGELOG\.md)" > /dev/null; then
    warning "ะะทะผะตะฝะตะฝั ัะฐะนะปั README/CHANGELOG - ะทะฐะฟัััะธัะต npm run docs ะฟะพัะปะต ะบะพะผะผะธัะฐ"
fi

# ะะฑะฝะพะฒะปะตะฝะธะต API ะดะพะบัะผะตะฝัะฐัะธะธ ะตัะปะธ ะธะทะผะตะฝะธะปะธัั routes/models
if git diff --cached --name-only | grep -E "(backend/server\.js|backend/models/|backend/routes/)" > /dev/null; then
    warning "ะะทะผะตะฝะตะฝั backend ัะฐะนะปั - API docs ะฑัะดัั ะพะฑะฝะพะฒะปะตะฝั ะฐะฒัะพะผะฐัะธัะตัะบะธ"
fi

# 6. ะัะพะฒะตัะบะฐ ัะพัะผะฐัะฐ commit ัะพะพะฑัะตะฝะธั (conventional commits)
echo "๐ ะัะพะฒะตัะบะฐ ัะพัะผะฐัะฐ commit ัะพะพะฑัะตะฝะธั..."
COMMIT_MSG_FILE="$1"

if [ -n "$COMMIT_MSG_FILE" ] && [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(head -n1 "$COMMIT_MSG_FILE")

    # ะัะพะฒะตัะบะฐ ะฝะฐ conventional commit format (ัะฟัะพัะตะฝะฝะฐั)
    if ! echo "$COMMIT_MSG" | grep -E '^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: .+' > /dev/null; then
        if ! echo "$COMMIT_MSG" | grep -E '^(Revert|Merge|BREAKING).+' > /dev/null; then
            warning "ะะพะผะผะธั ัะพะพะฑัะตะฝะธะต ะฝะต ัะพะพัะฒะตัััะฒัะตั conventional commits ัะพัะผะฐัั"
            echo "ะะตะบะพะผะตะฝะดัะตะผัะน ัะพัะผะฐั: type(scope): description"
            echo "ะัะธะผะตัั: feat(ui): add new chat interface"
            echo "         fix(api): resolve auth token issue"
        fi
    else
        success "Commit ัะพะพะฑัะตะฝะธะต ัะพะพัะฒะตัััะฒัะตั conventional commits"
    fi
fi

# 7. ะัะพะฒะตัะบะฐ ะบะพะฝัะปะธะบัะพะฒ ะผะฐัะบะตัะพะฒ (ะฑััััะฐั)
echo "๐ ะัะพะฒะตัะบะฐ ะบะพะฝัะปะธะบัะพะฒ ะผะฐัะบะตัะพะฒ..."
cd "$REPO_ROOT"

if git diff --cached | grep -E '^(<<<<<<<|=======|>>>>>>>)' > /dev/null; then
    error "ะะฑะฝะฐััะถะตะฝั ะบะพะฝัะปะธะบัั ะผะฐัะบะตัะพะฒ ะฒ staged ัะฐะนะปะฐั!"
    git diff --cached | grep -n -E '^(<<<<<<<|=======|>>>>>>>)' | head -5
    exit 1
else
    success "ะะพะฝัะปะธะบัั ะผะฐัะบะตัะพะฒ ะฝะต ะฝะฐะนะดะตะฝั"
fi

# ะคะธะฝะฐะปะธะทะฐัะธั
echo ""
echo "๐ ะะตะทัะปััะฐัั pre-commit ะฟัะพะฒะตัะบะธ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ $FAILED_LINT -ne 0 ] || [ $FAILED_SYNTAX -ne 0 ]; then
    error "ะะตะบะพัะพััะต ะฟัะพะฒะตัะบะธ ะฟัะพะฒะฐะปะธะปะธัั!"
    echo ""
    echo "๐ก ะัะฟัะฐะฒััะต ะพัะธะฑะบะธ ะธ ะฟะพะฒัะพัะธัะต git add && git commit"
    echo "๐ง ะะปั ะฒัะตะผะตะฝะฝะพะณะพ ะฟัะพะฟััะบะฐ ะฟัะพะฒะตัะพะบ ะฒัะฟะพะปะฝะธัะต:"
    echo "   git commit --no-verify"
    echo ""
    exit 1
fi

success "ะัะต ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั! ๐"
echo ""
echo "๐ก ะะพัะปะต push ะฑัะดะตั ะฒัะฟะพะปะฝะตะฝะฐ ะฟะพะปะฝะฐั ะฒะฐะปะธะดะฐัะธั (ัะตััั, coverage)"

# ะัะพะฑัะฐะถะตะฝะธะต ััะฐัะธััะธะบะธ ะธะทะผะตะฝะตะฝะธะน
echo ""
echo "๐ ะกัะฐัะธััะธะบะฐ ะธะทะผะตะฝะตะฝะธะน:"
git diff --cached --stat --color | cat

exit 0